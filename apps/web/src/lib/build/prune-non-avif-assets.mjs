import fs from 'node:fs/promises'
import path from 'node:path'
import process from 'node:process'

const RASTER_EXT = new Set(['.png', '.jpg', '.jpeg', '.webp', '.gif'])

async function walk(dir) {
  const entries = await fs.readdir(dir, { withFileTypes: true })
  const files = []
  for (const entry of entries) {
    const full = path.join(dir, entry.name)
    if (entry.isDirectory()) {
      files.push(...(await walk(full)))
      continue
    }
    files.push(full)
  }
  return files
}

export async function pruneNonAvifAssets({ distDir }) {
  const files = await walk(distDir)

  await Promise.all(
    files.map(async (file) => {
      const rel = path.relative(distDir, file).replace(/\\/g, '/')
      const ext = path.extname(file).toLowerCase()

      if (!RASTER_EXT.has(ext)) return
      // keep build chunks/images generated by Astro itself
      if (rel.startsWith('_astro/')) return

      await fs.unlink(file)
    })
  )
}

if (import.meta.url === `file://${process.argv[1]}`) {
  const distDir = path.resolve(process.cwd(), process.argv[2] || '../../dist')
  await pruneNonAvifAssets({ distDir })
}
