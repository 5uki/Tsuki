---
// 椤堕儴瀵艰埅鏍忕粍浠?
import { THEME_METAS } from '@tsuki/shared/theme'
import tsukiConfig from '@/config/tsuki-config'
import type { NavLink } from '@tsuki/config'

const navLinks: NavLink[] = tsukiConfig.nav ?? []
const siteTitle = tsukiConfig.site.title
---

<header class="header group sticky top-0 z-[100] bg-transparent transition-[background-color] duration-150 [--tsuki-header-collapse-offset:-78px] [--tsuki-header-track-duration:220ms] max-md:[--tsuki-header-frame-bottom-gap:0px] max-md:[--tsuki-header-pill-height:50px]">
  <div class="header-inner relative mx-auto w-full max-w-[var(--tsuki-page-width)] px-[var(--tsuki-page-inline-padding)] py-[var(--tsuki-header-inner-padding-block)] max-md:mx-0 max-md:max-w-none max-md:px-0">
    <div class="header-track relative grid items-center [grid-template-columns:minmax(0,1fr)_auto_minmax(0,1fr)] gap-[clamp(1.1rem,3vw,2.4rem)] [margin-top:calc(-1*(var(--tsuki-header-frame-top-gap)+var(--tsuki-header-frame-top-overflow)))] [margin-inline:calc(var(--tsuki-main-inline-padding)+var(--tsuki-header-card-align-offset))] px-[var(--tsuki-header-frame-side-gap)] pt-[calc(var(--tsuki-header-frame-top-gap)+var(--tsuki-header-frame-top-overflow))] pb-[var(--tsuki-header-frame-bottom-gap)] rounded-[var(--tsuki-header-frame-radius)] border border-transparent bg-transparent shadow-none [--tsuki-header-track-shift-y:0px] [transform:translateY(var(--tsuki-header-track-shift-y))] transition-[transform,background-color,border-color,box-shadow] [transition-duration:var(--tsuki-header-track-duration),160ms,160ms,160ms] [transition-timing-function:linear,ease-out,ease-out,ease-out] group-[.scrolled]:bg-[var(--tsuki-header-frame-bg)] group-[.scrolled]:border-[var(--tsuki-header-frame-border)] group-[.scrolled]:shadow-[var(--tsuki-header-frame-shadow)] group-[.in-main]:[--tsuki-header-track-shift-y:var(--tsuki-header-collapse-offset)] group-[.in-main]:pointer-events-none group-[.in-main-approach]:pointer-events-none max-md:grid-cols-[1fr] max-md:mx-0 max-md:px-0">
      <div class="header-pill header-brand relative z-[1] flex h-[var(--tsuki-header-pill-height)] items-center gap-[0.8rem] rounded-full border border-[var(--tsuki-header-pill-border)] bg-[var(--tsuki-header-pill-bg)] px-[1.45rem] shadow-[var(--tsuki-shadow-header)] transition-[background-color,border-color,box-shadow,transform] duration-150 [transform:translateY(0)] justify-self-start max-md:hidden">
        <a href="/" class="logo inline-flex h-[38px] items-center gap-[0.6rem] text-inherit no-underline">
          <img src="/favicon.svg" alt="" class="logo-favicon inline-block h-5 w-5 shrink-0 rounded-[var(--tsuki-radius-3sm)]" width="22" height="22" />
          <span class="logo-text text-[var(--tsuki-text-3xl)] font-bold text-[var(--tsuki-theme-accent)] transition-colors duration-150">{siteTitle}</span>
        </a>
      </div>

      <nav class="header-pill nav relative z-[1] hidden h-[var(--tsuki-header-pill-height)] items-center justify-center gap-[1.4rem] rounded-full border border-[var(--tsuki-header-pill-border)] bg-[var(--tsuki-header-pill-bg)] px-[1.9rem] shadow-[var(--tsuki-shadow-header)] transition-[background-color,border-color,box-shadow,transform] duration-150 [transform:translateY(var(--tsuki-header-center-pill-shift-y))] mx-[var(--tsuki-header-center-safe-inline)] justify-self-center md:flex">
        {navLinks.map(link => (
          <a
            href={link.href}
            class="relative inline-flex h-[38px] items-center px-[0.35rem] text-[var(--tsuki-text-lg)] font-medium text-[var(--tsuki-fg)] transition-colors duration-150 after:absolute after:-bottom-1 after:left-0 after:right-0 after:h-[2px] after:scale-x-0 after:bg-[var(--tsuki-theme-accent)] after:transition-transform after:duration-150 hover:text-[var(--tsuki-fg)] hover:after:scale-x-100"
          >
            {link.label}
          </a>
        ))}
      </nav>

      <div class="header-pill actions relative z-[1] flex h-[var(--tsuki-header-pill-height)] items-center gap-[0.5rem] rounded-full border border-[var(--tsuki-header-pill-border)] bg-[var(--tsuki-header-pill-bg)] px-[1.15rem] shadow-[var(--tsuki-shadow-header)] transition-[background-color,border-color,box-shadow,transform] duration-150 justify-self-end [transform:translateY(var(--tsuki-actions-base-shift-y))] max-md:justify-self-stretch max-md:mx-[5px] max-md:min-w-[calc(100%-10px)] max-md:justify-start max-md:gap-[0.45rem] max-md:px-[1.05rem] max-md:[--tsuki-actions-base-shift-y:-10px]">
      <div class="mobile-left hidden min-w-0 items-center max-md:flex max-md:mr-auto">
        <a href="/" class="logo mobile-logo inline-flex h-[38px] items-center gap-[0.6rem] text-inherit no-underline">
          <img src="/favicon.svg" alt="" class="logo-favicon inline-block h-[1.15rem] w-[1.15rem] shrink-0 rounded-[var(--tsuki-radius-2sm)]" width="20" height="20" />
          <span class="logo-text text-[var(--tsuki-text-2xl)] font-bold leading-none text-[var(--tsuki-theme-accent)]">{siteTitle}</span>
        </a>
      </div>

      <a href="/search" class="action-btn search-btn inline-flex h-[38px] w-[38px] items-center justify-center rounded-full border border-[var(--tsuki-header-pill-border)] bg-transparent text-[var(--tsuki-fg)] transition-[background-color,color,border-color] duration-150 hover:border-[var(--tsuki-theme-accent)] hover:bg-[var(--tsuki-header-pill-bg)] hover:text-[var(--tsuki-fg)] max-md:h-[36px] max-md:w-[36px]" aria-label="搜索">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </a>

      <div class="theme-switcher">
        <button id="theme-toggle" class="action-btn inline-flex h-[38px] w-[38px] items-center justify-center rounded-full border border-[var(--tsuki-header-pill-border)] bg-transparent text-[var(--tsuki-fg)] transition-[background-color,color,border-color] duration-150 hover:border-[var(--tsuki-theme-accent)] hover:bg-[var(--tsuki-header-pill-bg)] hover:text-[var(--tsuki-fg)] max-md:h-[36px] max-md:w-[36px]" aria-label="切换主题" aria-haspopup="true">
          <svg class="theme-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a9 9 0 1 0 0 18h1.2a2.3 2.3 0 0 0 2.3-2.3c0-.8-.4-1.5-1.1-1.9-.6-.4-.9-1-.9-1.7 0-1.1.9-2 2-2h2.1A5.4 5.4 0 0 0 18.6 8.4 9 9 0 0 0 12 3z"></path>
            <circle cx="8.6" cy="9.6" r="1" fill="currentColor" stroke="none"></circle>
            <circle cx="11.7" cy="7.6" r="1" fill="currentColor" stroke="none"></circle>
            <circle cx="8.1" cy="13.7" r="1" fill="currentColor" stroke="none"></circle>
          </svg>
        </button>
        <div id="theme-dropdown" class="theme-dropdown absolute left-0 right-0 top-[calc(100%+0.85rem)] w-auto overflow-hidden rounded-[var(--tsuki-radius-xl)] border border-[color-mix(in_srgb,var(--tsuki-theme-secondary)_64%,var(--tsuki-color-on-primary))] bg-[var(--tsuki-header-dropdown-bg)] shadow-[var(--tsuki-shadow-popover),0_0_0_1px_color-mix(in_srgb,var(--tsuki-theme-accent)_5%,transparent)] opacity-0 invisible -translate-y-2 scale-[0.96] transition-[opacity,transform] duration-200 ease-[cubic-bezier(0.16,1,0.3,1)] data-[open=true]:visible data-[open=true]:translate-y-0 data-[open=true]:scale-100 data-[open=true]:opacity-100 group-[.in-main]:pointer-events-none group-[.in-main]:opacity-0 group-[.in-main]:invisible group-[.in-main]:-translate-y-2 group-[.in-main]:scale-[0.96] max-md:left-auto max-md:right-0 max-md:w-[min(16.5rem,calc((100vw-10px)*0.66))] max-md:max-w-[calc(100vw-10px)]" role="menu" data-open="false">
          <div class="border-b border-[color-mix(in_srgb,color-mix(in_srgb,var(--tsuki-theme-secondary)_64%,var(--tsuki-color-on-primary))_50%,transparent)] px-4 pb-[0.625rem] pt-[0.875rem] text-[var(--tsuki-text-xxs)] font-semibold uppercase tracking-[0.08em] text-[var(--tsuki-fg)]">选择主题</div>
          {THEME_METAS.map(theme => (
            <button
              class="theme-option group relative flex w-full items-center gap-3 border-none bg-transparent px-4 py-3 text-left text-[var(--tsuki-text-base)] text-[var(--tsuki-fg)] transition-[color,transform] duration-180 ease-out before:absolute before:inset-[6px] before:rounded-[var(--tsuki-radius-md)] before:bg-[linear-gradient(90deg,color-mix(in_srgb,var(--theme-tint)_14%,transparent),color-mix(in_srgb,var(--theme-tint)_4%,transparent))] before:opacity-0 before:transition-opacity before:duration-180 hover:before:opacity-100 data-[active=true]:before:opacity-100 data-[active=true]:before:bg-[linear-gradient(90deg,color-mix(in_srgb,var(--theme-tint)_22%,transparent),color-mix(in_srgb,var(--theme-tint)_8%,transparent))] cursor-pointer"
              data-theme-name={theme.id}
              style={`--theme-color: ${theme.gradientColor}; --theme-tint: ${theme.accentColor}; --theme-border: color-mix(in srgb, ${theme.accentColor} 45%, transparent);`}
              role="menuitem"
              data-active="false"
            >
              <span class="theme-preview relative z-[1] h-[22px] w-[22px] shrink-0 rounded-full border-2 border-[var(--theme-border)] bg-[var(--theme-color)] shadow-[var(--tsuki-shadow-theme-preview)] transition-[transform,box-shadow] duration-200 ease-out group-hover:scale-110 group-hover:shadow-[var(--tsuki-shadow-theme-preview-hover)]"></span>
              <span class="theme-name z-[1] flex-1 font-medium transition-colors duration-180 group-hover:text-[var(--tsuki-theme-accent)]">{theme.name}</span>
              <span class="theme-check z-[1] text-[var(--tsuki-text-base)] text-[var(--tsuki-theme-accent)] opacity-0 scale-50 transition-[opacity,transform] duration-200 ease-[cubic-bezier(0.34,1.56,0.64,1)] group-data-[active=true]:opacity-100 group-data-[active=true]:scale-100">✓</span>
            </button>
          ))}
        </div>
      </div>

      <a href="/login" class="login-btn inline-flex h-[38px] items-center gap-2 rounded-full border border-[color-mix(in_srgb,var(--tsuki-theme-accent)_30%,transparent)] bg-[color-mix(in_srgb,var(--tsuki-theme-accent)_18%,transparent)] px-[0.95rem] text-[var(--tsuki-text-md)] font-medium text-[var(--tsuki-fg)] transition-opacity duration-150 hover:opacity-90 max-md:h-[36px] max-md:w-[36px] max-md:justify-center max-md:px-0 max-md:bg-transparent max-md:text-[var(--tsuki-fg)] max-md:border-[var(--tsuki-header-pill-border)] max-md:hover:bg-[var(--tsuki-header-pill-bg)] max-md:hover:border-[var(--tsuki-theme-accent)]">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
        </svg>
        <span class="max-md:hidden">登录</span>
      </a>

      <div class="mobile-menu-switcher">
        <button id="mobile-menu-btn" class="action-btn mobile-menu-btn hidden h-[38px] w-[38px] items-center justify-center rounded-full border border-[var(--tsuki-header-pill-border)] bg-transparent text-[var(--tsuki-fg)] transition-[background-color,color,border-color] duration-150 hover:border-[var(--tsuki-theme-accent)] hover:bg-[var(--tsuki-header-pill-bg)] hover:text-[var(--tsuki-fg)] max-md:flex max-md:h-[36px] max-md:w-[36px]" aria-label="菜单" aria-haspopup="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"></path>
          </svg>
        </button>
        <nav id="mobile-nav" class="mobile-nav-dropdown absolute left-0 right-0 top-[calc(100%+0.85rem)] w-auto overflow-hidden rounded-[var(--tsuki-radius-xl)] border border-[color-mix(in_srgb,var(--tsuki-theme-secondary)_64%,var(--tsuki-color-on-primary))] bg-[var(--tsuki-header-dropdown-bg)] shadow-[var(--tsuki-shadow-popover),0_0_0_1px_color-mix(in_srgb,var(--tsuki-theme-accent)_5%,transparent)] opacity-0 invisible -translate-y-2 scale-[0.96] transition-[opacity,transform] duration-200 ease-[cubic-bezier(0.16,1,0.3,1)] data-[open=true]:visible data-[open=true]:translate-y-0 data-[open=true]:scale-100 data-[open=true]:opacity-100 group-[.in-main]:pointer-events-none group-[.in-main]:opacity-0 group-[.in-main]:invisible group-[.in-main]:-translate-y-2 group-[.in-main]:scale-[0.96] max-md:left-auto max-md:right-0 max-md:w-[min(16.5rem,calc((100vw-10px)*0.66))] max-md:max-w-[calc(100vw-10px)]" role="menu" data-open="false">
          {navLinks.map(link => (
            <a href={link.href} class="block border-b border-[color-mix(in_srgb,color-mix(in_srgb,var(--tsuki-theme-secondary)_64%,var(--tsuki-color-on-primary))_50%,transparent)] px-4 py-[0.8rem] text-[var(--tsuki-text-md)] text-[var(--tsuki-fg)] transition-[color,background-color] duration-150 last:border-b-0 hover:bg-[color-mix(in_srgb,var(--tsuki-theme-accent)_8%,transparent)] hover:text-[var(--tsuki-theme-accent)]">{link.label}</a>
          ))}
        </nav>
      </div>
      </div>
    </div>
  </div>
</header>

<script>
  // 涓婚鍒囨崲鍔熻兘
  import { THEMES, DEFAULT_THEME, type Theme } from '@tsuki/shared/theme'
  import { createStorageAdapter } from '@adapters/storage'

  const header = document.querySelector<HTMLElement>('.header')
  const headerTrack = document.querySelector<HTMLElement>('.header-track')
  const main = document.querySelector<HTMLElement>('main.main')
  const toggle = document.getElementById('theme-toggle')
  const dropdown = document.getElementById('theme-dropdown')
  const themeOptions = document.querySelectorAll('.theme-option')
  const mobileMenuBtn = document.getElementById('mobile-menu-btn')
  const mobileNav = document.getElementById('mobile-nav')
  const storage = createStorageAdapter()

  const setOpenState = (element: HTMLElement | null, isOpen: boolean) => {
    if (!element) return
    element.setAttribute('data-open', isOpen ? 'true' : 'false')
  }

  function getCurrentTheme(): Theme {
    const theme = document.documentElement.getAttribute('data-theme')
    return THEMES.includes(theme as Theme) ? (theme as Theme) : DEFAULT_THEME
  }

  function setTheme(theme: Theme) {
    document.documentElement.setAttribute('data-theme', theme)
    storage.setTheme(theme)
    updateActiveTheme()
  }

  function updateActiveTheme() {
    const current = getCurrentTheme()
    themeOptions.forEach(option => {
      const isActive = option.getAttribute('data-theme-name') === current
      option.setAttribute('data-active', isActive ? 'true' : 'false')
    })
  }

  function toggleDropdown() {
    if (!dropdown) return
    const isOpen = dropdown.getAttribute('data-open') === 'true'
    setOpenState(dropdown, !isOpen)
  }

  function closeDropdown() {
    setOpenState(dropdown as HTMLElement | null, false)
  }

  function closeMobileNav() {
    setOpenState(mobileNav as HTMLElement | null, false)
  }

  function closeAllMenus() {
    closeDropdown()
    closeMobileNav()
  }

  function updateHeaderState() {
    const isScrolled = window.scrollY > 8
    header?.classList.toggle('scrolled', isScrolled)

    // 杩涘叆涓诲唴瀹瑰尯鍩熷悗锛屾敹璧疯儗鏅潯涓庝腑蹇冭兌鍥娿€?
    if (!main || !header) return
    const mainTop = main.getBoundingClientRect().top
    const headerHeight = header.getBoundingClientRect().height
    const trackHeight = headerTrack?.getBoundingClientRect().height ?? headerHeight
    const collapseOffset = Math.ceil(headerHeight + 24)
    header.style.setProperty('--tsuki-header-collapse-offset', `-${collapseOffset}px`)
    const collapseTriggerPx = Math.round(trackHeight - 19)
    const approachTriggerPx = collapseTriggerPx + 10
    const inMain = mainTop <= collapseTriggerPx
    const inMainApproach = mainTop <= approachTriggerPx
    header.classList.toggle('in-main-approach', inMainApproach)
    header.classList.toggle('in-main', inMain)
    if (inMainApproach) {
      closeAllMenus()
    }
  }

  // 涓婚鍒囨崲浜嬩欢
  toggle?.addEventListener('click', (e) => {
    e.stopPropagation()
    closeMobileNav()
    toggleDropdown()
  })

  themeOptions.forEach(option => {
    option.addEventListener('click', () => {
      const theme = option.getAttribute('data-theme-name') as Theme
      if (theme && THEMES.includes(theme)) {
        setTheme(theme)
        closeDropdown()
      }
    })
  })

  // 绉诲姩绔彍鍗?
  mobileMenuBtn?.addEventListener('click', (e) => {
    e.stopPropagation()
    closeDropdown()
    if (!mobileNav) return
    const isOpen = mobileNav.getAttribute('data-open') === 'true'
    setOpenState(mobileNav, !isOpen)
  })

  // 鐐瑰嚮澶栭儴鍏抽棴鎵€鏈夎彍鍗?
  document.addEventListener('click', (e) => {
    const target = e.target as Node
    if (!dropdown?.contains(target) && target !== toggle &&
        !mobileNav?.contains(target) && target !== mobileMenuBtn) {
      closeAllMenus()
    }
  })

  // 閿洏鍏抽棴
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeAllMenus()
    }
  })

  // 婊氬姩鏍峰紡
  updateHeaderState()
  window.addEventListener('scroll', updateHeaderState, { passive: true })
  window.addEventListener('resize', updateHeaderState, { passive: true })

  // 鍒濆鍖?
  updateActiveTheme()
</script>
