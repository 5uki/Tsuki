---
import type { CalendarData, CalendarIndex } from '@contracts/content'

interface Props {
  calendarData: CalendarData
  calendarIndex: CalendarIndex
}

const { calendarData, calendarIndex } = Astro.props
const { year, month, articles } = calendarData

const today = new Date()
const todayYear = today.getFullYear()
const todayMonth = today.getMonth() + 1
const todayDay = today.getDate()

// 构建当月日历网格
const firstDay = new Date(year, month - 1, 1).getDay() // 0=周日
const daysInMonth = new Date(year, month, 0).getDate()

// 有文章的日期集合
const articleDays = new Set(articles.map((a) => a.day))
---

<div class="tsuki-sidebar-card calendar-card" data-calendar-card>
  <div class="calendar-header">
    <button class="calendar-nav-btn" data-calendar-prev aria-label="上一月">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14">
        <path d="M10 3L5 8l5 5" />
      </svg>
    </button>
    <span class="calendar-title" data-calendar-title>{year}年{month}月</span>
    <button class="calendar-nav-btn" data-calendar-next aria-label="下一月">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14">
        <path d="M6 3l5 5-5 5" />
      </svg>
    </button>
  </div>

  <div class="calendar-weekdays">
    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
  </div>

  <div class="calendar-grid" data-calendar-grid>
    {Array.from({ length: firstDay }).map(() => (
      <span class="calendar-day empty"></span>
    ))}
    {Array.from({ length: daysInMonth }, (_, i) => i + 1).map((day) => {
      const isToday = year === todayYear && month === todayMonth && day === todayDay
      const hasArticle = articleDays.has(day)
      return (
        <span
          class:list={['calendar-day', { 'is-today': isToday, 'has-article': hasArticle }]}
        >
          {day}
        </span>
      )
    })}
  </div>

  <div class="calendar-articles" data-calendar-articles>
    {articles.length > 0 ? (
      articles.map((article) => (
        <a href={`/posts/${article.slug}`} class="calendar-article-item">
          <span class="article-day">{month}/{article.day}</span>
          <span class="article-title">{article.title}</span>
        </a>
      ))
    ) : (
      <span class="empty-text">本月暂无文章</span>
    )}
  </div>

  <script
    is:inline
    type="application/json"
    data-calendar-index
    set:html={JSON.stringify(calendarIndex)}
  />
  <script
    is:inline
    type="application/json"
    data-calendar-today
    set:html={JSON.stringify({ year: todayYear, month: todayMonth, day: todayDay })}
  />
</div>

<script>
  function initCalendar() {
    document.querySelectorAll<HTMLElement>('[data-calendar-card]').forEach((card) => {
      const indexEl = card.querySelector<HTMLScriptElement>('[data-calendar-index]')
      const todayEl = card.querySelector<HTMLScriptElement>('[data-calendar-today]')
      if (!indexEl || !todayEl) return

      const index = JSON.parse(indexEl.textContent || '{}') as Record<string, { slug: string; title: string; day: number }[]>
      const todayInfo = JSON.parse(todayEl.textContent || '{}') as { year: number; month: number; day: number }

      function escapeHtml(text: string): string {
        const el = document.createElement('span')
        el.textContent = text
        return el.innerHTML
      }

      const titleEl = card.querySelector<HTMLElement>('[data-calendar-title]')
      const gridEl = card.querySelector<HTMLElement>('[data-calendar-grid]')
      const articlesEl = card.querySelector<HTMLElement>('[data-calendar-articles]')
      const prevBtn = card.querySelector<HTMLButtonElement>('[data-calendar-prev]')
      const nextBtn = card.querySelector<HTMLButtonElement>('[data-calendar-next]')

      if (!titleEl || !gridEl || !articlesEl || !prevBtn || !nextBtn) return

      const titleRef = titleEl
      const gridRef = gridEl
      const articlesRef = articlesEl

      let currentYear = todayInfo.year
      let currentMonth = todayInfo.month

      function renderMonth() {
        titleRef.textContent = `${currentYear}年${currentMonth}月`

        // 淡出
        gridRef.classList.add('switching')
        articlesRef.classList.add('switching')

        setTimeout(() => {
          const firstDayOfWeek = new Date(currentYear, currentMonth - 1, 1).getDay()
          const totalDays = new Date(currentYear, currentMonth, 0).getDate()
          const key = `${currentYear}-${String(currentMonth).padStart(2, '0')}`
          const monthArticles = index[key] || []
          const articleDaySet = new Set(monthArticles.map((a: { day: number }) => a.day))

          let gridHtml = ''
          for (let i = 0; i < firstDayOfWeek; i++) {
            gridHtml += '<span class="calendar-day empty"></span>'
          }
          for (let d = 1; d <= totalDays; d++) {
            const isToday = currentYear === todayInfo.year && currentMonth === todayInfo.month && d === todayInfo.day
            const hasArticle = articleDaySet.has(d)
            const classes = ['calendar-day']
            if (isToday) classes.push('is-today')
            if (hasArticle) classes.push('has-article')
            gridHtml += `<span class="${classes.join(' ')}">${d}</span>`
          }
          gridRef.innerHTML = gridHtml

          let articlesHtml = ''
          if (monthArticles.length > 0) {
            monthArticles.forEach((article: { slug: string; title: string; day: number }) => {
              articlesHtml += `<a href="/posts/${escapeHtml(article.slug)}" class="calendar-article-item">
              <span class="article-day">${currentMonth}/${article.day}</span>
              <span class="article-title">${escapeHtml(article.title)}</span>
            </a>`
            })
          } else {
            articlesHtml = '<span class="empty-text">本月暂无文章</span>'
          }
          articlesRef.innerHTML = articlesHtml

          // 强制 reflow 后淡入
          void gridRef.offsetHeight
          gridRef.classList.remove('switching')
          articlesRef.classList.remove('switching')
        }, 120)
      }

      prevBtn.addEventListener('click', () => {
        currentMonth--
        if (currentMonth < 1) {
          currentMonth = 12
          currentYear--
        }
        renderMonth()
      })

      nextBtn.addEventListener('click', () => {
        currentMonth++
        if (currentMonth > 12) {
          currentMonth = 1
          currentYear++
        }
        renderMonth()
      })
    })
  }

  initCalendar()
  document.addEventListener('astro:page-load', initCalendar)
</script>

<style>
  .calendar-card {
    padding: var(--tsuki-sidebar-card-padding) var(--tsuki-sidebar-card-padding-inline);
  }
  @media (min-width: 640px) {
    .calendar-card {
      padding: var(--tsuki-sidebar-card-padding-compact) var(--tsuki-sidebar-card-padding-inline-compact);
    }
  }

  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--tsuki-space-0-75);
  }

  .calendar-nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.75rem;
    height: 1.75rem;
    padding: 0;
    background: var(--tsuki-surface-muted-soft);
    border: 1px solid var(--tsuki-surface-border);
    border-radius: var(--tsuki-radius-sm);
    cursor: pointer;
    color: var(--tsuki-post-muted-fg);
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out),
                border-color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out),
                background-color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .calendar-nav-btn:hover {
    color: var(--tsuki-theme-accent);
    border-color: var(--tsuki-theme-accent);
    background: var(--tsuki-surface-accent-soft);
  }

  .calendar-title {
    font-size: var(--tsuki-sidebar-body-text-size);
    font-weight: 600;
    color: var(--tsuki-fg);
  }
  @media (min-width: 640px) {
    .calendar-title {
      font-size: var(--tsuki-sidebar-body-text-size-desktop);
    }
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    margin-bottom: var(--tsuki-space-0-25);
  }

  .calendar-weekdays span {
    font-size: var(--tsuki-text-xs);
    font-weight: 600;
    color: var(--tsuki-post-muted-fg);
    padding: var(--tsuki-space-0-15) 0;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    margin-bottom: var(--tsuki-space-0-75);
    transition: opacity 120ms ease;
  }

  .calendar-articles {
    display: flex;
    flex-direction: column;
    gap: var(--tsuki-space-0-3);
    border-top: 1px solid var(--tsuki-surface-border);
    padding-top: var(--tsuki-space-0-5);
    transition: opacity 120ms ease;
  }

  .calendar-grid.switching,
  .calendar-articles.switching {
    opacity: 0;
  }
</style>

<style is:global>
  /* 动态元素样式（innerHTML 生成的元素没有 Astro scoped 属性，
     必须用 is:global 并以静态父级 .calendar-card 限定作用域） */

  .calendar-card .calendar-day {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
    font-size: var(--tsuki-text-xs);
    font-weight: 400;
    color: var(--tsuki-fg);
    border-radius: var(--tsuki-radius-sm);
  }

  .calendar-card .calendar-day.empty {
    visibility: hidden;
  }

  .calendar-card .calendar-day.is-today {
    font-weight: 700;
    color: var(--tsuki-theme-accent);
    background: var(--tsuki-surface-accent-soft);
  }

  .calendar-card .calendar-day.has-article::after {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--tsuki-theme-accent);
  }

  .calendar-card .calendar-article-item {
    display: flex;
    align-items: baseline;
    gap: var(--tsuki-space-0-5);
    padding: var(--tsuki-space-0-25) var(--tsuki-space-0-3);
    border-radius: var(--tsuki-radius-sm);
    text-decoration: none;
    color: var(--tsuki-fg);
    transition: background-color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .calendar-card .calendar-article-item:hover {
    background: var(--tsuki-surface-accent-soft);
  }

  .calendar-card .article-day {
    flex-shrink: 0;
    font-size: var(--tsuki-text-xs);
    font-weight: 400;
    color: var(--tsuki-post-muted-fg);
    font-variant-numeric: tabular-nums;
  }

  .calendar-card .article-title {
    font-size: var(--tsuki-text-xs);
    font-weight: 500;
    color: var(--tsuki-fg);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  @media (min-width: 640px) {
    .calendar-card .article-title {
      font-size: var(--tsuki-text-2xs);
    }
  }

  .calendar-card .empty-text {
    font-size: var(--tsuki-sidebar-body-text-size);
    font-weight: 400;
    color: var(--tsuki-post-muted-fg);
  }
</style>
