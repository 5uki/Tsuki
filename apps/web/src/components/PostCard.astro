---
import type { PostCardItem } from '@atoms/post-cards'
import { Icon } from 'astro-icon/components'

interface Props {
  post: PostCardItem
  class?: string
}

const { post, class: className } = Astro.props
const postHref = `/posts/${post.slug}`
const hasCover = !!post.cover
---

<div
  class:list={[
    'post-card-wrapper relative flex w-full flex-col-reverse overflow-hidden rounded-[var(--tsuki-sidebar-card-radius)] border border-[var(--tsuki-sidebar-card-border)] bg-[var(--tsuki-sidebar-card-bg)] shadow-[var(--tsuki-sidebar-card-shadow)] tsuki-card-transition hover:translate-y-[var(--tsuki-sidebar-card-hover-translate)] hover:border-[var(--tsuki-sidebar-card-border-hover)] hover:shadow-[var(--tsuki-sidebar-card-shadow-hover)] md:min-h-[var(--tsuki-post-card-min-height)] md:flex-col',
    {
      'has-cover': hasCover,
      'no-cover': !hasCover,
      'border-[var(--tsuki-theme-accent)] hover:border-[var(--tsuki-theme-accent)]': !!post.pinned,
    },
    className,
  ]}
>
  <div
    class:list={[
      'post-card-content relative flex min-h-full flex-col p-[var(--tsuki-space-1-5)] md:py-[var(--tsuki-space-1-75)] md:pl-[var(--tsuki-space-2-25)] md:pr-[var(--tsuki-space-0-5)]',
      {
        'md:w-[calc(100%-var(--tsuki-post-cover-width)-var(--tsuki-post-cover-gap))] md:min-h-[var(--tsuki-post-card-min-height)]': hasCover,
        'md:w-full md:pr-[var(--tsuki-space-2-25)]': !hasCover,
      },
    ]}
  >
    <a href={postHref} class="post-card-title group mb-[var(--tsuki-space-0-75)] inline-flex w-fit max-w-full items-center text-[length:var(--tsuki-text-post-title)] font-bold leading-[var(--tsuki-line-height-heading)] text-[color:var(--tsuki-post-title-fg)] no-underline transition-colors duration-[var(--tsuki-motion-fast)] ease-[var(--tsuki-motion-ease-out)] hover:text-[color:var(--tsuki-theme-accent)] focus-visible:text-[color:var(--tsuki-theme-accent)] md:relative md:max-w-[calc(100%-var(--tsuki-space-0-5))] md:before:absolute md:before:top-[var(--tsuki-space-0-35)] md:before:h-[var(--tsuki-space-1-25)] md:before:w-[var(--tsuki-space-0-25)] md:before:rounded-[var(--tsuki-radius-xs)] md:before:bg-[var(--tsuki-theme-accent)] md:before:content-['']">
      <span class="break-words">{post.title}</span>
      <span class="ml-[var(--tsuki-space-0-2)] inline-flex h-[var(--tsuki-post-title-arrow-size)] w-[var(--tsuki-post-title-arrow-size)] items-center justify-center text-[color:var(--tsuki-theme-accent)] md:hidden" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m9 18 6-6-6-6"></path>
        </svg>
      </span>
      <span class="ml-[var(--tsuki-space-0-2)] hidden h-[var(--tsuki-post-title-arrow-size)] w-[var(--tsuki-post-title-arrow-size)] items-center justify-center text-[color:var(--tsuki-theme-accent)] opacity-0 translate-x-[var(--tsuki-translate-0-2)] transition-[opacity,transform] duration-[var(--tsuki-motion-fast)] ease-[var(--tsuki-motion-ease-out)] group-hover:opacity-100 group-hover:translate-x-0 group-focus-visible:opacity-100 group-focus-visible:translate-x-0 md:inline-flex" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m9 18 6-6-6-6"></path>
        </svg>
      </span>
    </a>

    <div class="post-meta mb-[var(--tsuki-space-0-5)] flex flex-wrap items-center gap-x-[var(--tsuki-space-0-85)] gap-y-[var(--tsuki-space-0-6)]">
      {post.pinned && (
        <span class="meta-row inline-flex h-[var(--tsuki-meta-icon-badge-size)] min-w-0 items-center gap-[var(--tsuki-space-0-15)] rounded-[var(--tsuki-radius-0-45)] bg-[var(--tsuki-post-pinned-bg)] pr-[var(--tsuki-space-0-45)] leading-none">
          <span class="meta-icon-badge grid h-[var(--tsuki-meta-icon-badge-size)] w-[var(--tsuki-meta-icon-badge-size)] place-items-center rounded-[var(--tsuki-radius-0-4)] bg-[var(--tsuki-post-pinned-bg)]">
            <Icon name="material-symbols:pinboard" class="meta-icon h-[var(--tsuki-meta-icon-size)] w-[var(--tsuki-meta-icon-size)] text-[color:var(--tsuki-theme-accent)]" />
          </span>
          <span class="meta-text whitespace-nowrap text-[length:var(--tsuki-text-meta)] font-[550] leading-[var(--tsuki-line-height-meta)] text-[color:var(--tsuki-theme-accent)] sm:text-[length:var(--tsuki-sidebar-body-text-size-desktop)]">置顶</span>
        </span>
      )}

      <span class="meta-row inline-flex min-w-0 items-center gap-[var(--tsuki-space-0-3)] leading-none">
        <span class="meta-icon-badge grid h-[var(--tsuki-meta-icon-badge-size)] w-[var(--tsuki-meta-icon-badge-size)] place-items-center rounded-[var(--tsuki-radius-0-4)] bg-[var(--tsuki-theme-secondary)]">
          <Icon name="material-symbols:calendar-today-outline-rounded" class="meta-icon h-[var(--tsuki-meta-icon-size)] w-[var(--tsuki-meta-icon-size)] text-[color:var(--tsuki-theme-accent)]" />
        </span>
        <time datetime={post.publishedAt} class="meta-text whitespace-nowrap text-[length:var(--tsuki-text-meta)] font-normal leading-[var(--tsuki-line-height-meta)] text-[color:var(--tsuki-post-meta-fg)] sm:text-[length:var(--tsuki-sidebar-body-text-size-desktop)]">{post.publishedAt}</time>
      </span>

      <span class="meta-row inline-flex min-w-0 items-center gap-[var(--tsuki-space-0-3)] leading-none">
        <span class="meta-icon-badge grid h-[var(--tsuki-meta-icon-badge-size)] w-[var(--tsuki-meta-icon-badge-size)] place-items-center rounded-[var(--tsuki-radius-0-4)] bg-[var(--tsuki-theme-secondary)]">
          <Icon name="material-symbols:book-2-outline-rounded" class="meta-icon h-[var(--tsuki-meta-icon-size)] w-[var(--tsuki-meta-icon-size)] text-[color:var(--tsuki-theme-accent)]" />
        </span>
        <span class="meta-text whitespace-nowrap text-[length:var(--tsuki-text-meta)] font-normal leading-[var(--tsuki-line-height-meta)] text-[color:var(--tsuki-post-meta-fg)] sm:text-[length:var(--tsuki-sidebar-body-text-size-desktop)]">{post.category}</span>
      </span>

      <span class="meta-row inline-flex min-w-0 items-center gap-[var(--tsuki-space-0-3)] leading-none">
        <span class="meta-icon-badge grid h-[var(--tsuki-meta-icon-badge-size)] w-[var(--tsuki-meta-icon-badge-size)] place-items-center rounded-[var(--tsuki-radius-0-4)] bg-[var(--tsuki-theme-secondary)]">
          <Icon name="material-symbols:article-outline-rounded" class="meta-icon h-[var(--tsuki-meta-icon-size)] w-[var(--tsuki-meta-icon-size)] text-[color:var(--tsuki-theme-accent)]" />
        </span>
        <span class="meta-text whitespace-nowrap text-[length:var(--tsuki-text-meta)] font-normal leading-[var(--tsuki-line-height-meta)] text-[color:var(--tsuki-post-meta-fg)] sm:text-[length:var(--tsuki-sidebar-body-text-size-desktop)]">{post.words} 字</span>
      </span>
    </div>

    <p class="description mt-0 mb-[var(--tsuki-space-0-6)] pr-[var(--tsuki-space-1)] text-[length:var(--tsuki-text-post-summary)] leading-[var(--tsuki-line-height-base)] text-[color:var(--tsuki-post-muted-fg)] [display:-webkit-box] [-webkit-line-clamp:2] [-webkit-box-orient:vertical] overflow-hidden">
      {post.summary}
    </p>

    <div class="stats mt-auto flex flex-wrap gap-[var(--tsuki-space-0-5)]">
      {post.tags.map(tag => (
        <a
          href={`/tags/${tag.toLowerCase()}`}
          class="tag-item inline-block rounded-[var(--tsuki-radius-md)] bg-[var(--tsuki-surface-accent-strong)] px-[var(--tsuki-space-0-625)] py-[var(--tsuki-space-0-3125)] text-[length:var(--tsuki-text-sm-compact)] font-medium text-[color:var(--tsuki-theme-accent)] no-underline transition-[background-color,transform] duration-[var(--tsuki-motion-fast)] ease-[var(--tsuki-motion-ease-out)] hover:translate-y-[var(--tsuki-translate-1px)] hover:bg-[var(--tsuki-surface-accent-soft)] sm:px-[var(--tsuki-space-0-75)] sm:py-[var(--tsuki-space-0-375)]"
        >
          {tag}
        </a>
      ))}
    </div>
  </div>

  {hasCover && (
    <a href={postHref} class="post-card-image group relative block w-full overflow-hidden rounded-t-[var(--tsuki-sidebar-card-radius)] no-underline aspect-[2/1] md:absolute md:bottom-[var(--tsuki-post-cover-padding)] md:right-[var(--tsuki-post-cover-padding)] md:top-[var(--tsuki-post-cover-padding)] md:h-[calc(100%-var(--tsuki-post-cover-padding)*2)] md:w-[var(--tsuki-post-cover-width)] md:rounded-[var(--tsuki-radius-lg)]" aria-label={`阅读 ${post.title}`}>
      <img src={post.cover} alt="" class="cover-image block h-full w-full object-cover transition-transform duration-[var(--tsuki-motion-slow)] ease-[var(--tsuki-motion-ease-out)] group-hover:scale-[var(--tsuki-scale-cover-hover)] group-active:scale-[var(--tsuki-scale-cover-active)]" loading="lazy" decoding="async" />
    </a>
  )}
</div>

<style>
  @media (min-width: 768px) {
    .post-card-title::before {
      left: calc(var(--tsuki-space-1-25) * -1);
    }
  }

  :global(.grid-mode) .post-card-wrapper {
    flex-direction: column-reverse;
    height: 100%;
    justify-content: flex-end;
  }

  :global(.grid-mode) .post-card-content {
    width: 100%;
    padding-right: var(--tsuki-space-1);
    height: auto;
    flex-grow: 1;
  }

  :global(.grid-mode) .no-cover .post-card-content {
    padding-right: var(--tsuki-space-1);
  }

  :global(.grid-mode) .post-card-image {
    position: relative;
    top: auto;
    bottom: auto;
    right: auto;
    width: 100%;
    margin: 0;
    border-radius: var(--tsuki-sidebar-card-radius) var(--tsuki-sidebar-card-radius) 0 0;
    max-height: none;
    aspect-ratio: 2 / 1;
  }

  :global(.grid-mode) .description {
    flex-grow: 0;
  }

  :global(.grid-mode) .stats {
    margin-top: auto;
  }

  :global(.grid-mode) .has-cover .post-card-content {
    padding-top: var(--tsuki-space-0-8);
  }

  :global(.grid-mode) .has-cover .post-card-title::before {
    top: var(--tsuki-space-1-3);
  }
</style>
