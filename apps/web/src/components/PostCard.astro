---
import type { PostCardItem } from '@atoms/post-cards'
import { Icon } from 'astro-icon/components'

interface Props {
  post: PostCardItem
  class?: string
}

const { post, class: className } = Astro.props
const postHref = `/posts/${post.slug}`
const hasCover = !!post.cover
---

<div
  class:list={[
    'post-card-wrapper',
    { 'has-cover': hasCover, 'no-cover': !hasCover, 'pinned': !!post.pinned },
    className,
  ]}
>
  <div class="post-card-content">
    <a href={postHref} class="post-card-title">
      <span class="title-text">{post.title}</span>
      <span class="title-arrow-mobile" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m9 18 6-6-6-6"></path>
        </svg>
      </span>
      <span class="title-arrow-desktop" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m9 18 6-6-6-6"></path>
        </svg>
      </span>
    </a>

    <div class="post-meta">
      {post.pinned && (
        <span class="meta-row pinned-row">
          <span class="meta-icon-badge">
            <Icon name="material-symbols:pinboard" class="meta-icon" />
          </span>
          <span class="meta-text">置顶</span>
        </span>
      )}

      <span class="meta-row date-row">
        <span class="meta-icon-badge">
          <Icon name="material-symbols:calendar-today-outline-rounded" class="meta-icon" />
        </span>
        <time datetime={post.publishedAt} class="meta-text">{post.publishedAt}</time>
      </span>

      <span class="meta-row">
        <span class="meta-icon-badge">
          <Icon name="material-symbols:book-2-outline-rounded" class="meta-icon" />
        </span>
        <span class="meta-text">{post.category}</span>
      </span>

      <span class="meta-row">
        <span class="meta-icon-badge">
          <Icon name="material-symbols:article-outline-rounded" class="meta-icon" />
        </span>
        <span class="meta-text">{post.words} 字</span>
      </span>
    </div>

    <p class="description">{post.summary}</p>

    <div class="stats">
      {post.tags.map(tag => (
        <a href={`/tags/${tag.toLowerCase()}`} class="tag-item">{tag}</a>
      ))}
    </div>
  </div>

  {hasCover && (
    <a href={postHref} class="post-card-image" aria-label={`阅读 ${post.title}`}>
      <img src={post.cover} alt="" class="cover-image" loading="lazy" decoding="async" />
    </a>
  )}
</div>

<style>
  .post-card-wrapper {
    --tsuki-post-cover-width: 30%;
    --tsuki-post-enter-bg: color-mix(in srgb, var(--tsuki-theme-secondary) 24%, var(--tsuki-sidebar-card-bg));
    --tsuki-post-enter-bg-hover: color-mix(in srgb, var(--tsuki-theme-secondary) 36%, var(--tsuki-sidebar-card-bg));
    --tsuki-post-enter-bg-active: color-mix(in srgb, var(--tsuki-theme-secondary) 45%, var(--tsuki-sidebar-card-bg));
    --tsuki-post-meta-fg: color-mix(in srgb, var(--tsuki-fg) 68%, transparent);
    --tsuki-post-muted-fg: color-mix(in srgb, var(--tsuki-fg) 74%, transparent);
    position: relative;
    width: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column-reverse;
    border-radius: var(--tsuki-sidebar-card-radius);
    border: 1px solid var(--tsuki-sidebar-card-border);
    background: var(--tsuki-sidebar-card-bg);
    box-shadow: var(--tsuki-sidebar-card-shadow);
    transition:
      transform 130ms cubic-bezier(0.22, 1, 0.36, 1),
      box-shadow 140ms ease-out,
      border-color 130ms ease-out;
  }

  .post-card-wrapper:hover {
    transform: translateY(var(--tsuki-sidebar-card-hover-translate));
    border-color: var(--tsuki-sidebar-card-border-hover);
    box-shadow: var(--tsuki-sidebar-card-shadow-hover);
  }

  .post-card-content {
    position: relative;
    padding: 1.5rem;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
    display: flex;
    flex-direction: column;
    min-height: 100%;
  }

  .post-card-title {
    display: inline-flex;
    align-items: center;
    width: fit-content;
    max-width: 100%;
    margin: 0 0 0.75rem;
    line-height: 1.3;
    font-size: 1.5rem;
    font-weight: 700;
    color: color-mix(in srgb, var(--tsuki-fg) 90%, transparent);
    text-decoration: none;
    transition: color 140ms ease;
  }

  .title-text {
    overflow-wrap: anywhere;
  }

  .title-arrow-mobile {
    display: inline-block;
    margin-left: 0.2rem;
    font-size: 0.9em;
    line-height: 1;
    color: var(--tsuki-theme-accent);
    width: 2rem;
    height: 2rem;
  }

  .title-arrow-desktop {
    display: none;
    margin-left: 0.2rem;
    font-size: 0.9em;
    line-height: 1;
    color: var(--tsuki-theme-accent);
    opacity: 0;
    transform: translateX(-0.2rem);
    transition: opacity 140ms ease, transform 140ms ease;
    width: 2rem;
    height: 2rem;
  }

  .post-card-title:hover,
  .post-card-title:focus-visible {
    color: var(--tsuki-theme-accent);
    text-decoration: none;
  }

  .post-card-title:hover .title-arrow-desktop,
  .post-card-title:focus-visible .title-arrow-desktop {
    opacity: 1;
    transform: translateX(0);
  }

  .post-meta {
    --tsuki-meta-icon-badge-size: 1.56rem;
    --tsuki-meta-icon-size: 0.9rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.6rem 0.85rem;
    margin-bottom: 0.7rem;
  }

  .meta-row {
    display: inline-flex;
    align-items: center;
    line-height: 1;
    min-width: 0;
    gap: 0.3rem;
  }

  .pinned-row {
    padding: 0.2rem 0.45rem;
    border-radius: 0.45rem;
    background: color-mix(in srgb, var(--tsuki-theme-secondary) 40%, var(--tsuki-sidebar-card-bg));
  }

  .meta-icon {
    display: inline-flex;
    width: 1.28rem;
    height: 1.28rem;
    align-items: center;
    justify-content: center;
    color: var(--tsuki-fg);
    line-height: 1;
    flex-shrink: 0;
  }

  .meta-icon-badge {
    display: grid;
    place-items: center;
    width: var(--tsuki-meta-icon-badge-size);
    min-width: var(--tsuki-meta-icon-badge-size);
    max-width: var(--tsuki-meta-icon-badge-size);
    height: var(--tsuki-meta-icon-badge-size);
    min-height: var(--tsuki-meta-icon-badge-size);
    max-height: var(--tsuki-meta-icon-badge-size);
    flex: 0 0 var(--tsuki-meta-icon-badge-size);
    border-radius: 0.4rem;
    background: var(--tsuki-theme-secondary);
  }

  .meta-icon-badge .meta-icon {
    width: 1rem;
    height: 1rem;
    color: var(--tsuki-theme-accent);
  }

  .date-row .meta-text {
    color: color-mix(in srgb, var(--tsuki-fg) 60%, transparent);
  }

  .meta-text {
    font-size: 0.84rem;
    line-height: 1.25rem;
    font-weight: 500;
    color: var(--tsuki-post-meta-fg);
    white-space: nowrap;
  }

  .description {
    margin: 0;
    margin-bottom: 0.85rem;
    padding-right: 1rem;
    color: var(--tsuki-post-muted-fg);
    line-height: 1.7;
    font-size: 0.96rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .stats {
    margin-top: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-item {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    background: color-mix(in srgb, var(--tsuki-theme-accent) 10%, transparent);
    color: var(--tsuki-theme-accent);
    font-size: 0.8125rem;
    border-radius: 0.5rem;
    font-weight: 500;
    text-decoration: none;
    transition: background-color 0.15s, transform 0.15s;
  }

  .tag-item:hover {
    background: color-mix(in srgb, var(--tsuki-theme-accent) 20%, transparent);
    transform: translateY(-2px);
    text-decoration: none;
  }

  .post-card-image {
    position: relative;
    display: block;
    width: 100%;
    aspect-ratio: 2 / 1;
    border-radius: var(--tsuki-sidebar-card-radius) var(--tsuki-sidebar-card-radius) 0 0;
    text-decoration: none;
    overflow: hidden;
  }

  .cover-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 220ms ease-out;
  }

  .post-card-image:hover .cover-image {
    transform: scale(1.03);
  }

  .post-card-image:active {
    transform: scale(0.95);
  }

  @media (min-width: 769px) {
    .post-card-wrapper {
      min-height: 12.8rem;
      flex-direction: column;
    }

    .post-card-content {
      padding: 1.75rem 0.5rem 1.75rem 2.25rem;
    }

    .post-card-title {
      margin-bottom: 0.75rem;
      font-size: 1.5rem;
      max-width: calc(100% - 0.5rem);
      position: relative;
    }

    .post-card-title::before {
      content: '';
      position: absolute;
      left: -1.5rem;
      top: 0.35rem;
      width: 0.25rem;
      height: 1.25rem;
      border-radius: 0.25rem;
      background: var(--tsuki-theme-accent);
    }

    .title-arrow-mobile {
      display: none;
    }

    .title-arrow-desktop {
      display: inline-block;
    }

    .has-cover .post-card-content {
      width: calc(100% - var(--tsuki-post-cover-width) - 1.5rem);
      min-height: 12.8rem;
    }

    .post-card-image {
      position: absolute;
      top: 1rem;
      right: 1rem;
      bottom: 1rem;
      width: var(--tsuki-post-cover-width);
      height: calc(100% - 2rem);
      aspect-ratio: auto;
      border-radius: 0.75rem;
    }

    .no-cover .post-card-content {
      width: 100%;
      padding-right: 2.25rem;
    }

    .has-cover .description {
      -webkit-line-clamp: 2;
      line-clamp: 2;
    }
  }

  .post-card-wrapper.pinned {
    border-color: var(--tsuki-theme-accent);
  }

  .post-card-wrapper.pinned:hover {
    border-color: var(--tsuki-theme-accent);
  }

  .post-card-wrapper.pinned .post-card-title::before {
    background: var(--tsuki-theme-accent);
  }

  .post-card-wrapper.pinned .pinned-row {
    background: color-mix(in srgb, var(--tsuki-theme-accent) 20%, var(--tsuki-sidebar-card-bg));
  }

  .post-card-wrapper.pinned .pinned-row .meta-icon {
    color: var(--tsuki-theme-accent);
  }

  @media (max-width: 640px) {
    .tag-item {
      padding: 0.3125rem 0.625rem;
    }
  }

  /* Grid Mode Styles */
  :global(.grid-mode) .post-card-wrapper {
    flex-direction: column-reverse !important;
    height: 100% !important;
    justify-content: flex-end !important;
  }

  :global(.grid-mode) .post-card-content {
    width: 100% !important;
    padding-right: 1rem !important;
    height: auto !important;
    flex-grow: 1 !important;
  }

  :global(.grid-mode) .no-cover .post-card-content {
    padding-right: 1rem !important;
  }

  :global(.grid-mode) .post-card-image {
    position: relative !important;
    top: auto !important;
    bottom: auto !important;
    right: auto !important;
    width: 100% !important;
    margin: 0 !important;
    border-radius: var(--tsuki-sidebar-card-radius) var(--tsuki-sidebar-card-radius) 0 0 !important;
    max-height: none !important;
    aspect-ratio: 2/1 !important;
  }

  :global(.grid-mode) .description {
    flex-grow: 0 !important;
  }

  :global(.grid-mode) .stats {
    margin-top: auto !important;
  }

  :global(.grid-mode) .has-cover .post-card-content {
    padding-top: 0.8rem !important;
  }

  :global(.grid-mode) .has-cover .post-card-title::before {
    top: 1.3rem !important;
  }

</style>
