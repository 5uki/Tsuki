---
/**
 * ImageGrid - 图片网格组件
 *
 * 布局规则：
 * - 1 张：单图 100% 宽
 * - 2 张：两列等宽
 * - 3 张：左侧大图 + 右侧两小图
 * - 4 张：2x2 网格
 * - >4 张：前 3 张 + 第 4 张带 +N 覆盖
 */

interface Props {
  images: string[]
  maxDisplay?: number
}

const { images, maxDisplay = 4 } = Astro.props

const count = images.length
const overflow = count > maxDisplay
const displayImages = overflow ? images.slice(0, maxDisplay) : images
const remaining = count - maxDisplay

function layoutClass(total: number): string {
  if (total === 1) return 'grid-single'
  if (total === 2) return 'grid-two'
  if (total === 3) return 'grid-three'
  return 'grid-four'
}

const gridClass = overflow ? 'grid-four' : layoutClass(count)
---

{count > 0 && (
  <div class:list={['image-grid', gridClass]} data-lightbox-group>
    {displayImages.map((src, i) => (
      <div
        class:list={[
          'image-grid-cell',
          { 'cell-overflow': overflow && i === maxDisplay - 1 },
        ]}
      >
        <img
          src={src}
          alt=""
          class="image-grid-img"
          loading="lazy"
          decoding="async"
          data-lightbox={JSON.stringify({ src, index: i, total: count, all: JSON.stringify(images) })}
        />
        {overflow && i === maxDisplay - 1 && (
          <span class="overflow-badge" aria-label={`还有 ${remaining} 张图片`}>
            +{remaining}
          </span>
        )}
      </div>
    ))}
  </div>
)}

<style>
  .image-grid {
    display: grid;
    gap: var(--tsuki-space-xs);
    border-radius: var(--tsuki-radius-md);
    overflow: hidden;
  }

  /* 1 image: full width */
  .grid-single {
    grid-template-columns: 1fr;
  }
  .grid-single .image-grid-cell {
    max-height: 20rem;
  }

  /* 2 images: two columns */
  .grid-two {
    grid-template-columns: 1fr 1fr;
  }
  .grid-two .image-grid-cell {
    aspect-ratio: 4 / 3;
  }

  /* 3 images: left large + right two small */
  .grid-three {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }
  .grid-three .image-grid-cell:first-child {
    grid-row: 1 / 3;
  }
  .grid-three .image-grid-cell:not(:first-child) {
    aspect-ratio: 4 / 3;
  }

  /* 4 images: 2x2 grid */
  .grid-four {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }
  .grid-four .image-grid-cell {
    aspect-ratio: 4 / 3;
  }

  .image-grid-cell {
    position: relative;
    overflow: hidden;
    border-radius: var(--tsuki-radius-md);
    cursor: pointer;
  }

  .image-grid-img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--tsuki-motion-slow) var(--tsuki-motion-ease-out);
  }
  .image-grid-cell:hover .image-grid-img {
    transform: scale(1.03);
  }

  .overflow-badge {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: color-mix(in srgb, var(--tsuki-fg) 50%, transparent);
    font-size: var(--tsuki-text-2xl);
    font-weight: 700;
    color: var(--tsuki-color-on-primary);
    pointer-events: none;
  }
</style>
