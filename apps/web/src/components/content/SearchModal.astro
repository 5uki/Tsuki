---
---

<div id="search-modal" class="search-overlay" role="dialog" aria-modal="true" aria-label="搜索">
  <div class="search-backdrop" data-search-close></div>
  <div class="search-dialog">
    <div class="search-header">
      <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input
        type="search"
        id="search-modal-input"
        class="search-input"
        placeholder="搜索文章..."
        autocomplete="off"
      />
      <span class="search-spinner" id="search-spinner"></span>
      <button class="search-close" data-search-close aria-label="关闭">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <div id="search-modal-body" class="search-body"></div>
    <div class="search-footer">
      <span class="sf-hint"><kbd>↑</kbd><kbd>↓</kbd> 选择</span>
      <span class="sf-hint"><kbd>↵</kbd> 打开</span>
      <span class="sf-hint"><kbd>esc</kbd> 关闭</span>
    </div>
  </div>
</div>

<script>
  interface TsukiSearchWindow extends Window {
    __tsukiSearchCleanup?: () => void
    __tsukiSearchBound?: boolean
  }

  const tsukiWindow = window as TsukiSearchWindow
  let pf: any = null

  function initSearchModal() {
    tsukiWindow.__tsukiSearchCleanup?.()

    const overlay = document.getElementById('search-modal')!
    const input = document.getElementById('search-modal-input') as HTMLInputElement
    const body = document.getElementById('search-modal-body')!
    const spinner = document.getElementById('search-spinner')!
    if (!overlay || !input || !body || !spinner) return

    const controller = new AbortController()
    const signal = controller.signal

    let timer: ReturnType<typeof setTimeout>
    let idx = -1
    let items: HTMLAnchorElement[] = []

    function resetResults() {
      idx = -1
      items = []
    }

    function highlight() {
      items.forEach((el, i) => el.classList.toggle('is-active', i === idx))
      if (idx >= 0 && items[idx]) items[idx]!.scrollIntoView({ block: 'nearest' })
    }

    function lockScroll() {
      const sw = window.innerWidth - document.documentElement.clientWidth
      document.body.style.paddingRight = sw + 'px'
      document.body.style.overflow = 'hidden'
    }

    function unlockScroll() {
      document.body.style.overflow = ''
      document.body.style.paddingRight = ''
    }

    function open() {
      lockScroll()
      overlay.classList.add('open')
      input.value = ''
      body.innerHTML = ''
      resetResults()
      requestAnimationFrame(() => input.focus())
    }

    function close() {
      overlay.classList.remove('open')
      unlockScroll()
    }

    document.querySelectorAll('[data-search-open]').forEach(b =>
      b.addEventListener('click', (e) => { e.preventDefault(); open() }, { signal })
    )
    overlay.querySelectorAll('[data-search-close]').forEach(el =>
      el.addEventListener('click', close, { signal })
    )

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        overlay.classList.contains('open') ? close() : open()
      }
    }, { signal })

    overlay.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { close(); return }
      if (!items.length) return
      if (e.key === 'ArrowDown') {
        e.preventDefault()
        idx = (idx + 1) % items.length
        highlight()
      } else if (e.key === 'ArrowUp') {
        e.preventDefault()
        idx = idx <= 0 ? items.length - 1 : idx - 1
        highlight()
      } else if (e.key === 'Enter' && idx >= 0 && items[idx]?.href) {
        e.preventDefault()
        close()
        window.location.href = items[idx]!.href
      }
    }, { signal })

    input.addEventListener('input', () => {
      clearTimeout(timer)
      const q = input.value.trim()
      if (!q) {
        spinner.classList.remove('on')
        body.innerHTML = ''
        resetResults()
        return
      }
      spinner.classList.add('on')
      timer = setTimeout(() => search(q), 180)
    }, { signal })

    async function search(q: string) {
      try {
        if (!pf) {
          const load = new Function("return import('/pagefind/pagefind.js')")
          pf = await load()
          await pf.init()
        }
        const res = await pf.search(q)
        spinner.classList.remove('on')

        if (!res.results.length) {
          body.innerHTML = '<div class="search-nil">无匹配结果</div>'
          resetResults()
          return
        }

        const data = await Promise.all(
          res.results.slice(0, 8).map((r: any) => r.data())
        )

        body.innerHTML = data.map((d: any) =>
          `<a href="${d.url}" class="sr-item" data-sr>` +
            `<span class="sr-title">${d.meta?.title || '无标题'}</span>` +
            (d.excerpt ? `<span class="sr-excerpt">${d.excerpt}</span>` : '') +
          `</a>`
        ).join('')

        items = Array.from(body.querySelectorAll('[data-sr]'))
        idx = -1

        items.forEach((el, i) => {
          el.addEventListener('click', close)
          el.addEventListener('mouseenter', () => { idx = i; highlight() })
        })
      } catch {
        spinner.classList.remove('on')
        body.innerHTML = '<div class="search-nil">索引加载失败，请刷新重试</div>'
        resetResults()
      }
    }

    tsukiWindow.__tsukiSearchCleanup = () => controller.abort()
  }

  if (!tsukiWindow.__tsukiSearchBound) {
    document.addEventListener('astro:page-load', initSearchModal)
    tsukiWindow.__tsukiSearchBound = true
  }

  initSearchModal()
</script>

<style>
  /* ── Overlay: visibility 切换，不参与动画 ── */
  .search-overlay {
    position: fixed;
    inset: 0;
    z-index: 200;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: min(20vh, 8rem);
    visibility: hidden;
    pointer-events: none;
  }
  .search-overlay.open {
    visibility: visible;
    pointer-events: auto;
  }

  /* ── Backdrop: 独立过渡，100ms 快速出现 ── */
  .search-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    opacity: 0;
    transition: opacity 100ms ease;
  }
  .search-overlay.open .search-backdrop {
    opacity: 1;
  }

  /* ── Dialog: 独立过渡 ── */
  .search-dialog {
    position: relative;
    width: min(34rem, calc(100vw - 2rem));
    display: flex;
    flex-direction: column;
    border-radius: 0.875rem;
    border: 1px solid var(--tsuki-header-dropdown-border);
    background: var(--tsuki-header-dropdown-bg);
    box-shadow:
      var(--tsuki-shadow-popover),
      0 12px 40px -8px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    opacity: 0;
    transform: translateY(-8px) scale(0.97);
    transform-origin: top center;
    transition:
      opacity 120ms ease,
      transform 200ms cubic-bezier(0.16, 1, 0.3, 1);
  }
  .search-overlay.open .search-dialog {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  /* ── Input row ── */
  .search-header {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.75rem 1rem;
  }

  .search-icon {
    flex-shrink: 0;
    color: var(--tsuki-muted-fg);
    opacity: 0.7;
  }

  .search-input {
    flex: 1;
    min-width: 0;
    background: none;
    border: none;
    outline: none;
    font-family: inherit;
    font-size: 1rem;
    color: var(--tsuki-fg);
    padding: 0;
  }
  .search-input::placeholder {
    color: var(--tsuki-muted-fg);
  }
  .search-input::-webkit-search-cancel-button,
  .search-input::-webkit-search-decoration {
    -webkit-appearance: none;
    appearance: none;
    display: none;
  }

  .search-spinner {
    display: none;
    width: 0.875rem;
    height: 0.875rem;
    border: 2px solid var(--tsuki-surface-border);
    border-top-color: var(--tsuki-theme-accent);
    border-radius: 50%;
    flex-shrink: 0;
    animation: sp 0.55s linear infinite;
  }
  .search-spinner.on { display: block; }
  @keyframes sp { to { transform: rotate(360deg); } }

  /* ── Close button (X icon) ── */
  .search-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.75rem;
    height: 1.75rem;
    flex-shrink: 0;
    border-radius: 50%;
    border: none;
    background: none;
    color: var(--tsuki-muted-fg);
    cursor: pointer;
    transition: color 150ms ease;
  }
  .search-close:hover {
    color: var(--tsuki-fg);
  }

  /* ── Results body ── */
  .search-body {
    border-top: 1px solid var(--tsuki-header-dropdown-border-soft);
    max-height: min(50vh, 24rem);
    overflow-y: auto;
    overscroll-behavior: contain;
    padding: 0.375rem;
  }
  .search-body:empty {
    display: none;
  }

  .search-nil {
    padding: 1.25rem 0.625rem;
    text-align: center;
    font-size: 0.875rem;
    color: var(--tsuki-muted-fg);
  }

  /* ── Footer ── */
  .search-footer {
    display: flex;
    align-items: center;
    gap: 0.9rem;
    padding: 0.4rem 1rem;
    border-top: 1px solid var(--tsuki-header-dropdown-border-soft);
  }

  .sf-hint {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    font-size: 0.6875rem;
    color: var(--tsuki-muted-fg);
    white-space: nowrap;
  }
  .sf-hint kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.125rem;
    height: 1.125rem;
    padding: 0 0.2rem;
    border-radius: 3px;
    border: 1px solid var(--tsuki-surface-border);
    background: var(--tsuki-surface-muted-soft);
    font-size: 0.5625rem;
    font-family: inherit;
    color: var(--tsuki-muted-fg);
    line-height: 1;
    box-shadow: 0 1px 0 var(--tsuki-surface-border);
  }

  @media (max-width: 640px) {
    .search-overlay { padding-top: 0; }
    .search-dialog {
      width: 100%;
      max-width: none;
      border-radius: 0;
      border-left: none;
      border-right: none;
      border-top: none;
    }
    .search-body { max-height: 60vh; }
    .search-footer { display: none; }
  }
</style>

<style is:global>
  .sr-item {
    position: relative;
    display: block;
    padding: 0.55rem 0.75rem;
    border-radius: var(--tsuki-radius-md);
    text-decoration: none;
    color: var(--tsuki-fg);
  }

  .sr-item::before {
    content: '';
    position: absolute;
    inset: 2px;
    background: linear-gradient(90deg,
      color-mix(in srgb, var(--tsuki-theme-accent) 14%, transparent),
      color-mix(in srgb, var(--tsuki-theme-accent) 4%, transparent));
    border-radius: inherit;
    opacity: 0;
    transition: opacity 150ms ease;
    pointer-events: none;
  }
  .sr-item:hover::before,
  .sr-item.is-active::before {
    opacity: 1;
  }

  .sr-title {
    position: relative;
    z-index: 1;
    display: block;
    font-size: 0.9375rem;
    font-weight: 600;
    line-height: 1.4;
    color: var(--tsuki-fg);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 150ms ease;
  }
  .sr-item:hover .sr-title,
  .sr-item.is-active .sr-title {
    color: var(--tsuki-theme-accent);
  }

  .sr-excerpt {
    position: relative;
    z-index: 1;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-top: 0.125rem;
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--tsuki-muted-fg);
  }

  .sr-excerpt mark {
    background: none;
    color: var(--tsuki-theme-accent);
    font-weight: 600;
  }
</style>
