---
import type { PostCardItem } from '@/lib/utils/post-cards'
import { toSlug } from '@/lib/utils/post-cards'
import { Icon } from 'astro-icon/components'
import { toOptimizedImageUrl } from '@/lib/utils/image-url'

interface Props {
  post: PostCardItem
  class?: string
}

const { post, class: className } = Astro.props
const postHref = `/posts/${post.slug}`
const optimizedCover = toOptimizedImageUrl(post.cover)
const hasCover = !!optimizedCover
---

<div
  class:list={[
    'post-card-wrapper',
    {
      'has-cover': hasCover,
      'no-cover': !hasCover,
      'is-pinned': !!post.pinned,
    },
    className,
  ]}
  data-tags={post.tags.map((t) => toSlug(t)).join(',')}
  data-category={post.category ? toSlug(post.category) : ''}
  data-series={post.series ? toSlug(post.series) : ''}
>
  <div class:list={['post-card-content', { 'has-cover-content': hasCover }]}>
    <a href={postHref} class="post-card-title group">
      <span class="title-text">{post.title}</span>
      <span class="title-arrow" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m9 18 6-6-6-6"></path>
        </svg>
      </span>
    </a>

    <div class="post-meta">
      {
        post.pinned && (
          <span class="tsuki-meta-row pinned-badge">
            <span class="tsuki-meta-icon-badge pinned-icon-badge">
              <Icon name="material-symbols:pinboard" class="tsuki-meta-icon" />
            </span>
            <span class="pinned-text">置顶</span>
          </span>
        )
      }

      <span class="tsuki-meta-row">
        <span class="tsuki-meta-icon-badge">
          <Icon name="material-symbols:calendar-today-outline-rounded" class="tsuki-meta-icon" />
        </span>
        <time datetime={post.publishedAt} class="tsuki-meta-text">{post.publishedAt}</time>
      </span>

      {
        post.category && (
          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:book-2-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <a
              href={`/archives?category=${toSlug(post.category)}`}
              class="tsuki-meta-text meta-link"
            >
              {post.category}
            </a>
          </span>
        )
      }

      {
        post.series && (
          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon
                name="material-symbols:collections-bookmark-outline-rounded"
                class="tsuki-meta-icon"
              />
            </span>
            <a href={`/archives?series=${toSlug(post.series)}`} class="tsuki-meta-text meta-link">
              {post.series}
            </a>
          </span>
        )
      }

      <span class="tsuki-meta-row">
        <span class="tsuki-meta-icon-badge">
          <Icon name="material-symbols:article-outline-rounded" class="tsuki-meta-icon" />
        </span>
        <span class="tsuki-meta-text">{post.words} 字</span>
      </span>
    </div>

    <p class="description">
      {post.summary}
    </p>

    <div class="tag-list">
      {
        post.tags.map((tag) => (
          <a href={`/archives?tag=${toSlug(tag)}`} class="tsuki-tag-pill tag-item">
            {tag}
          </a>
        ))
      }
    </div>
  </div>

  {
    hasCover && (
      <a href={postHref} class="post-card-image" aria-label={`阅读 ${post.title}`}>
        <img src={optimizedCover} alt="" class="cover-image" loading="lazy" decoding="async" />
      </a>
    )
  }
</div>

<style>
  .post-card-wrapper {
    position: relative;
    display: flex;
    width: 100%;
    flex-direction: column-reverse;
    overflow: hidden;
    border-radius: var(--tsuki-sidebar-card-radius);
    border: 1px solid var(--tsuki-sidebar-card-border);
    background: var(--tsuki-sidebar-card-bg);
    box-shadow: var(--tsuki-sidebar-card-shadow);
    transition:
      transform var(--tsuki-motion-card) var(--tsuki-motion-card-ease),
      box-shadow var(--tsuki-motion-card) var(--tsuki-motion-ease-out),
      border-color var(--tsuki-motion-card) var(--tsuki-motion-ease-out);
  }
  .post-card-wrapper:hover {
    transform: translateY(var(--tsuki-sidebar-card-hover-translate));
    box-shadow: var(--tsuki-sidebar-card-shadow-hover);
    border-color: var(--tsuki-sidebar-card-border-hover);
  }
  .post-card-wrapper.is-pinned,
  .post-card-wrapper.is-pinned:hover {
    border-color: var(--tsuki-theme-accent);
  }
  @media (min-width: 768px) {
    .post-card-wrapper {
      min-height: var(--tsuki-post-card-min-height);
      flex-direction: column;
    }
  }

  .post-card-content {
    position: relative;
    display: flex;
    min-height: 100%;
    flex-direction: column;
    padding: var(--tsuki-space-2xl);
  }
  @media (min-width: 768px) {
    .post-card-content {
      padding: var(--tsuki-space-2xl) var(--tsuki-space-sm) var(--tsuki-space-2xl)
        var(--tsuki-space-3xl);
    }
    .has-cover-content {
      width: calc(100% - var(--tsuki-post-cover-width) - var(--tsuki-post-cover-gap));
      min-height: var(--tsuki-post-card-min-height);
    }
    .post-card-content:not(.has-cover-content) {
      width: 100%;
      padding-right: var(--tsuki-space-3xl);
    }
  }

  .post-card-title {
    display: inline-flex;
    width: fit-content;
    max-width: 100%;
    align-items: center;
    margin-bottom: var(--tsuki-space-md);
    font-size: var(--tsuki-text-post-title);
    font-weight: 700;
    line-height: var(--tsuki-line-height-heading);
    color: var(--tsuki-post-title-fg);
    text-decoration: none;
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .post-card-title:hover,
  .post-card-title:focus-visible {
    color: var(--tsuki-theme-accent);
  }
  @media (min-width: 768px) {
    .post-card-title {
      position: relative;
      max-width: calc(100% - var(--tsuki-space-sm));
    }
    .post-card-title::before {
      content: '';
      position: absolute;
      top: var(--tsuki-space-xs);
      left: calc(var(--tsuki-space-xl) * -1);
      height: var(--tsuki-space-xl);
      width: var(--tsuki-space-2xs);
      border-radius: var(--tsuki-radius-xs);
      background: var(--tsuki-theme-accent);
    }
  }

  .title-text {
    overflow-wrap: break-word;
  }

  .title-arrow {
    display: inline-flex;
    height: var(--tsuki-post-title-arrow-size);
    width: var(--tsuki-post-title-arrow-size);
    align-items: center;
    justify-content: center;
    margin-left: var(--tsuki-space-2xs);
    color: var(--tsuki-theme-accent);
  }
  @media (min-width: 768px) {
    .title-arrow {
      opacity: 0;
      transform: translateX(-0.2rem);
      transition:
        opacity var(--tsuki-motion-fast) var(--tsuki-motion-ease-out),
        transform var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
    }
    .post-card-title:hover .title-arrow,
    .post-card-title:focus-visible .title-arrow {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-sm) var(--tsuki-space-md);
    margin-bottom: var(--tsuki-space-sm);
  }

  .pinned-badge {
    height: var(--tsuki-meta-icon-badge-size);
    gap: var(--tsuki-space-3xs);
    border-radius: var(--tsuki-radius-sm);
    background: var(--tsuki-theme-secondary);
    padding-right: var(--tsuki-space-sm);
  }
  .pinned-icon-badge {
    background: var(--tsuki-theme-secondary);
  }
  .pinned-text {
    white-space: nowrap;
    font-size: var(--tsuki-text-meta);
    font-weight: 550;
    line-height: var(--tsuki-line-height-meta);
    color: var(--tsuki-theme-accent);
  }
  @media (min-width: 640px) {
    .pinned-text {
      font-size: var(--tsuki-sidebar-body-text-size-desktop);
    }
  }

  .description {
    margin-top: 0;
    margin-bottom: var(--tsuki-space-sm);
    padding-right: var(--tsuki-space-lg);
    font-size: var(--tsuki-text-post-summary);
    line-height: var(--tsuki-line-height-base);
    color: var(--tsuki-muted-fg);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tag-list {
    margin-top: auto;
    display: flex;
    flex-wrap: wrap;
    gap: var(--tsuki-space-sm);
  }

  .tag-item {
    font-size: var(--tsuki-text-sm);
  }

  .meta-link {
    text-decoration: none;
    color: var(--tsuki-muted-fg);
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .meta-link:hover {
    color: var(--tsuki-theme-accent);
  }

  .post-card-image {
    position: relative;
    display: block;
    width: 100%;
    overflow: hidden;
    border-radius: var(--tsuki-sidebar-card-radius) var(--tsuki-sidebar-card-radius) 0 0;
    text-decoration: none;
    aspect-ratio: 2 / 1;
  }
  @media (min-width: 768px) {
    .post-card-image {
      position: absolute;
      top: var(--tsuki-post-cover-padding);
      right: var(--tsuki-post-cover-padding);
      bottom: var(--tsuki-post-cover-padding);
      width: var(--tsuki-post-cover-width);
      height: calc(100% - var(--tsuki-post-cover-padding) * 2);
      border-radius: var(--tsuki-radius-lg);
      aspect-ratio: auto;
    }
  }

  .cover-image {
    display: block;
    height: 100%;
    width: 100%;
    object-fit: cover;
    transition: transform var(--tsuki-motion-slow) var(--tsuki-motion-ease-out);
  }
  .post-card-image:hover .cover-image {
    transform: scale(var(--tsuki-scale-cover-hover));
  }
  .post-card-image:active .cover-image {
    transform: scale(var(--tsuki-scale-cover-active));
  }

  /* ── Grid mode overrides ── */
  :global(.grid-mode) .post-card-wrapper {
    flex-direction: column-reverse;
    height: 100%;
    justify-content: flex-end;
  }
  :global(.grid-mode) .post-card-content {
    width: 100%;
    padding-right: var(--tsuki-space-lg);
    flex-grow: 1;
  }
  :global(.grid-mode) .post-card-image {
    position: relative;
    top: auto;
    bottom: auto;
    right: auto;
    width: 100%;
    border-radius: var(--tsuki-sidebar-card-radius) var(--tsuki-sidebar-card-radius) 0 0;
    aspect-ratio: 2 / 1;
  }
  :global(.grid-mode) .has-cover .post-card-content {
    padding-top: var(--tsuki-space-md);
  }
  :global(.grid-mode) .has-cover .post-card-title::before {
    top: var(--tsuki-space-xl);
  }
</style>
