---
import type { MarkdownHeading } from 'astro'

interface Props {
  headings: MarkdownHeading[]
}

const { headings = [] } = Astro.props
const displayHeadings = headings.filter((heading) => heading.depth >= 2 && heading.depth <= 4)

// 仅 h2 编号
let h2Count = 0
const headingsWithNumber = displayHeadings.map((heading) => {
  if (heading.depth === 2) {
    h2Count++
    return { ...heading, number: h2Count.toString() }
  }
  return { ...heading, number: null }
})
---

<div class="tsuki-sidebar-card toc-card">
  <h3 class="tsuki-section-title">
    目录
  </h3>
  {displayHeadings.length > 0 ? (
    <div class="toc-wrapper" id="toc-wrapper">
      <div class="toc-highlight" id="toc-highlight"></div>
      <ul class="toc-list" id="toc-list">
        {headingsWithNumber.map((heading) => (
          <li
            class:list={[
              'toc-item',
              { 'toc-h2': heading.depth === 2 },
              { 'toc-h3': heading.depth === 3 },
              { 'toc-h4': heading.depth === 4 },
            ]}
          >
            <a
              href={`#${heading.slug}`}
              class="toc-link"
              data-heading-id={heading.slug}
            >
              {heading.depth === 2 && heading.number && (
                <span class="toc-number">
                  {heading.number}
                </span>
              )}
              <span class="toc-text">
                {heading.text}
              </span>
            </a>
          </li>
        ))}
      </ul>
    </div>
  ) : (
    <p class="toc-empty">
      暂无目录
    </p>
  )}
</div>

<style>
  .toc-card {
    /* No hover transform for TOC card */
    will-change: auto;
  }
  .toc-card:hover {
    transform: none;
  }

  .toc-empty {
    margin: 0;
    font-size: var(--tsuki-sidebar-body-text-size);
    color: var(--tsuki-post-muted-fg);
  }

  .toc-wrapper {
    position: relative;
    max-height: 65vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: color-mix(in srgb, var(--tsuki-fg) 15%, transparent) transparent;
  }

  .toc-wrapper::-webkit-scrollbar {
    width: 4px;
  }
  .toc-wrapper::-webkit-scrollbar-track {
    background: transparent;
  }
  .toc-wrapper::-webkit-scrollbar-thumb {
    background: color-mix(in srgb, var(--tsuki-fg) 15%, transparent);
    border-radius: 2px;
  }

  .toc-highlight {
    position: absolute;
    left: 0;
    right: 0;
    border-radius: var(--tsuki-radius-md);
    background-color: var(--tsuki-surface-accent-soft);
    pointer-events: none;
    opacity: 0;
    transition: top 220ms cubic-bezier(0.25, 0.46, 0.45, 0.94),
                height 220ms cubic-bezier(0.25, 0.46, 0.45, 0.94),
                opacity 180ms ease;
    z-index: 0;
  }

  .toc-highlight.visible {
    opacity: 1;
  }

  .toc-list {
    position: relative;
    z-index: 1;
    margin: 0;
    padding: 0;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--tsuki-space-0-125);
    font-size: var(--tsuki-sidebar-body-text-size);
  }

  @media (min-width: 640px) {
    .toc-list {
      font-size: var(--tsuki-sidebar-body-text-size-desktop);
    }
  }

  .toc-h3 {
    padding-left: var(--tsuki-space-1);
  }
  .toc-h4 {
    padding-left: var(--tsuki-space-2);
  }

  .toc-link {
    display: inline-flex;
    width: 100%;
    align-items: center;
    gap: var(--tsuki-space-0-375);
    border-radius: var(--tsuki-radius-md);
    padding: var(--tsuki-space-0-375) var(--tsuki-space-0-5);
    color: var(--tsuki-fg);
    text-decoration: none;
    transition: color 150ms ease-out;
  }

  .toc-link:hover {
    color: var(--tsuki-theme-accent);
  }

  .toc-link.toc-active {
    color: var(--tsuki-fg);
  }

  .toc-number {
    display: inline-flex;
    height: 1.25rem;
    width: 1.25rem;
    flex-shrink: 0;
    align-items: center;
    justify-content: center;
    border-radius: var(--tsuki-radius-sm);
    background: var(--tsuki-theme-accent);
    font-size: var(--tsuki-text-xs);
    font-weight: 500;
    color: var(--tsuki-color-on-primary);
  }

  .toc-text {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
  }

  .toc-h4 .toc-link {
    color: color-mix(in srgb, var(--tsuki-fg) 38%, transparent);
  }
  .toc-h4 .toc-link:hover,
  .toc-h4 .toc-link.toc-active {
    color: color-mix(in srgb, var(--tsuki-fg) 38%, transparent);
  }
</style>

<script is:inline>
  // TOC 初始化函数：定义为全局函数以便 astro:page-load 也能调用
  window.__tsukiInitTOC = function() {
    // 清理上一次 SPA 导航留下的 scroll listener
    if (window.__tsukiTocCleanup) {
      window.__tsukiTocCleanup()
      window.__tsukiTocCleanup = null
    }

    var tocList = document.getElementById('toc-list')
    var tocHighlight = document.getElementById('toc-highlight')
    var tocWrapper = document.getElementById('toc-wrapper')
    var tocLinks = document.querySelectorAll('#toc-list .toc-link')
    var headingEls = document.querySelectorAll('article h2, article h3, article h4')

    if (!tocList || !tocHighlight || !tocWrapper || !tocLinks.length || !headingEls.length) return

    var list = tocList
    var highlight = tocHighlight
    var wrapper = tocWrapper

    // 轻量平滑滚动
    var scrollRaf = 0
    function smoothScrollToc(target) {
      cancelAnimationFrame(scrollRaf)
      var start = wrapper.scrollTop
      var diff = target - start
      if (Math.abs(diff) < 1) return
      var duration = Math.min(150, Math.abs(diff) * 1.5)
      var startTime = performance.now()
      function step(now) {
        var t = Math.min((now - startTime) / duration, 1)
        var ease = 1 - Math.pow(1 - t, 2)
        wrapper.scrollTop = start + diff * ease
        if (t < 1) scrollRaf = requestAnimationFrame(step)
      }
      scrollRaf = requestAnimationFrame(step)
    }

    var topOffset = 100
    var ticking = false

    function update() {
      var vh = window.innerHeight
      var activeIds = []
      var lastAboveId = null

      headingEls.forEach(function(el) {
        var top = el.getBoundingClientRect().top
        if (top < topOffset) {
          lastAboveId = el.id
        } else if (top >= topOffset && top < vh * 0.75) {
          activeIds.push(el.id)
        }
      })

      if (lastAboveId) {
        activeIds.push(lastAboveId)
      }

      tocLinks.forEach(function(link) {
        var id = link.getAttribute('data-heading-id')
        link.classList.toggle('toc-active', id !== null && activeIds.indexOf(id) !== -1)
      })

      if (activeIds.length === 0) {
        highlight.classList.remove('visible')
        ticking = false
        return
      }

      var items = list.querySelectorAll('.toc-item')
      var firstEl = null
      var lastEl = null

      items.forEach(function(item) {
        var link = item.querySelector('.toc-link')
        if (!link) return
        var id = link.getAttribute('data-heading-id')
        if (id && activeIds.indexOf(id) !== -1) {
          if (!firstEl) firstEl = item
          lastEl = item
        }
      })

      if (firstEl && lastEl) {
        var wrapperRect = wrapper.getBoundingClientRect()
        var firstRect = firstEl.getBoundingClientRect()
        var lastRect = lastEl.getBoundingClientRect()

        var top = firstRect.top - wrapperRect.top + wrapper.scrollTop
        var height = lastRect.bottom - firstRect.top

        highlight.style.top = top + 'px'
        highlight.style.height = height + 'px'
        highlight.classList.add('visible')

        var visibleTop = firstRect.top - wrapperRect.top
        var visibleBottom = lastRect.bottom - wrapperRect.top
        var wrapperHeight = wrapper.clientHeight
        var pad = 32

        if (visibleTop < pad) {
          smoothScrollToc(wrapper.scrollTop + visibleTop - pad)
        } else if (visibleBottom > wrapperHeight - pad) {
          smoothScrollToc(wrapper.scrollTop + visibleBottom - wrapperHeight + pad)
        }
      } else {
        highlight.classList.remove('visible')
      }

      ticking = false
    }

    function onScroll() {
      if (!ticking) {
        ticking = true
        requestAnimationFrame(update)
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true })
    window.__tsukiTocCleanup = function() {
      window.removeEventListener('scroll', onScroll)
      cancelAnimationFrame(scrollRaf)
    }

    update()
    requestAnimationFrame(function() { requestAnimationFrame(update) })
  }

  // 立即执行：处理首次加载和 is:inline 重新执行的情况
  window.__tsukiInitTOC()

  // 注册全局 astro:page-load 监听器（仅一次），确保每次 SPA 导航都能初始化
  if (!window.__tsukiTocPageLoadBound) {
    window.__tsukiTocPageLoadBound = true
    document.addEventListener('astro:page-load', function() {
      if (window.__tsukiInitTOC) window.__tsukiInitTOC()
    })
  }
</script>
