---
import type { GetStaticPathsOptions } from 'astro'
import Default from '@/layouts/Default.astro'
import PostCard from '@/components/content/PostCard.astro'
import Pagination from '@/components/content/Pagination.astro'
import { toPostCardItems } from '@/lib/utils/post-cards'
import { getPostEntries } from '@/lib/content'

export const prerender = true

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getPostEntries()
  const sorted = toPostCardItems(posts)
  return paginate(sorted, { pageSize: 10 })
}

const { page } = Astro.props
---

<Default title={page.currentPage > 1 ? `文章 - 第 ${page.currentPage} 页` : '文章'} description="所有文章列表">
  <section class="page-section">
    <div class="filter-bar" id="filter-bar">
      <span class="filter-label" id="filter-label"></span>
      <a href="/posts" class="filter-clear" id="filter-clear">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </a>
    </div>
    {page.data.length > 0 ? (
      <div class="tsuki-card-list" id="post-list">
        {page.data.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
    ) : (
      <p class="tsuki-empty-state">暂无文章</p>
    )}
    <p class="tsuki-empty-state filter-empty" id="filter-empty">无匹配文章</p>
    <div id="pagination-wrap">
      {page.lastPage > 1 && (
        <Pagination
          currentPage={page.currentPage}
          totalPages={page.lastPage}
          baseUrl="/posts"
        />
      )}
    </div>
  </section>
</Default>

<script>
  function initPostFilter() {
    const params = new URLSearchParams(window.location.search)
    const tag = params.get('tag')
    const category = params.get('category')
    const series = params.get('series')

    const filterBar = document.getElementById('filter-bar')
    const filterLabel = document.getElementById('filter-label')
    const filterEmpty = document.getElementById('filter-empty')
    const paginationWrap = document.getElementById('pagination-wrap')
    const postList = document.getElementById('post-list')
    if (!filterBar || !filterLabel || !filterEmpty || !paginationWrap) return

    const filterKey = tag ? 'tag' : category ? 'category' : series ? 'series' : null
    const filterValue = tag || category || series
    if (!filterKey || !filterValue) return

    const labels: Record<string, string> = {
      tag: '标签',
      category: '分类',
      series: '系列',
    }

    filterLabel.textContent = `${labels[filterKey]}：${filterValue}`
    filterBar.classList.add('active')
    paginationWrap.style.display = 'none'

    if (!postList) return

    const cards = postList.querySelectorAll<HTMLElement>('.post-card-wrapper')
    let visibleCount = 0

    cards.forEach((card) => {
      const attr = card.getAttribute(`data-${filterKey}`) || ''
      const values = attr.split(',').filter(Boolean)
      const match = values.some(v => v === filterValue)
      if (!match) {
        card.style.display = 'none'
      } else {
        visibleCount++
      }
    })

    if (visibleCount === 0) {
      filterEmpty.classList.add('active')
    }
  }

  initPostFilter()
  document.addEventListener('astro:page-load', initPostFilter)
</script>

<style>
  .page-section {
    margin-bottom: var(--tsuki-space-3xl);
  }

  .filter-bar {
    display: none;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--tsuki-space-lg);
    padding: var(--tsuki-space-sm) var(--tsuki-space-lg);
    border-radius: var(--tsuki-radius-md);
    border: 1px solid var(--tsuki-theme-accent);
    background: color-mix(in srgb, var(--tsuki-theme-accent) 8%, transparent);
  }
  .filter-bar.active {
    display: flex;
  }

  .filter-label {
    font-size: var(--tsuki-text-sm);
    font-weight: 500;
    color: var(--tsuki-fg);
  }

  .filter-clear {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--tsuki-muted-fg);
    text-decoration: none;
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .filter-clear:hover {
    color: var(--tsuki-fg);
  }

  .filter-empty {
    display: none;
  }
  .filter-empty.active {
    display: block;
  }
</style>
