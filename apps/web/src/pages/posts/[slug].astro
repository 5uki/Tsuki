---
import Default from '@/layouts/Default.astro'
import TableOfContents from '@/components/TableOfContents.astro'
import { createAppContext } from '@entry/index'
import { getPostCards, getPostDetail } from '@usecases/content'

export async function getStaticPaths() {
  const ctx = createAppContext()
  const posts = await getPostCards(ctx)
  return posts.map((post) => ({ params: { slug: post.slug } }))
}

const { slug } = Astro.params
const ctx = createAppContext()
const post = await getPostDetail(ctx, slug)
---

<Default title={post ? post.frontmatter.title : `文章: ${slug}`} description="文章详情" hasRightSidebar={!!post}>
  {post ? (
    <article
      class="tsuki-content-card rounded-[var(--tsuki-sidebar-card-radius)] border border-[var(--tsuki-sidebar-card-border)] bg-[var(--tsuki-sidebar-card-bg)] px-[var(--tsuki-space-1-5)] py-[var(--tsuki-space-1-75)] shadow-[var(--tsuki-sidebar-card-shadow)]"
      transition:name="page-card"
    >
      <header class="mb-[var(--tsuki-space-1-5)] border-b border-[var(--tsuki-surface-border)] pb-[var(--tsuki-space-1)]">
        <h1 class="mb-[var(--tsuki-space-0-5)] text-[length:var(--tsuki-text-3xl)] text-[color:var(--tsuki-fg)]">
          {post.frontmatter.title}
        </h1>
        <div class="flex flex-wrap items-center gap-[var(--tsuki-space-0-6)] text-[length:var(--tsuki-text-sm)] text-[color:var(--tsuki-post-muted-fg)]">
          <time datetime={post.frontmatter.publishedAt}>{post.frontmatter.publishedAt}</time>
          <span>{post.frontmatter.category}</span>
          <span>{post.frontmatter.words} 字</span>
        </div>
      </header>
      <div class="prose">
        <post.Content />
      </div>
    </article>
  ) : (
    <div class="tsuki-content-card rounded-[var(--tsuki-sidebar-card-radius)] border border-[var(--tsuki-sidebar-card-border)] bg-[var(--tsuki-sidebar-card-bg)] px-[var(--tsuki-space-1-5)] py-[var(--tsuki-space-1-75)] shadow-[var(--tsuki-sidebar-card-shadow)]">
      <p class="m-0 text-[length:var(--tsuki-text-sm)] text-[color:var(--tsuki-fg)]">
        未找到文章 {slug}
      </p>
    </div>
  )}
  <div slot="right">
    {post && <TableOfContents headings={post.headings} />}
  </div>
</Default>
