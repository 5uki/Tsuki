---
import Default from '@/layouts/Default.astro'
import TableOfContents from '@/components/content/TableOfContents.astro'
import CommentSection from '@/components/comments/CommentSection'
import { Icon } from 'astro-icon/components'
import { toSlug } from '@/lib/utils/post-cards'
import { getPostEntries, getPostBySlug } from '@/lib/content'
import tsukiConfig from '@/config/tsuki-config'

export const prerender = true

export async function getStaticPaths() {
  const posts = await getPostEntries()
  return posts.map((post) => ({ params: { slug: post.slug } }))
}

const { slug } = Astro.params
const post = await getPostBySlug(slug)
const readingTime = post ? Math.max(1, Math.ceil(post.words / 300)) : 0

const siteUrl = Astro.site?.origin ?? ''
const canonicalUrl = `${siteUrl}/posts/${slug}`
const authorName = tsukiConfig.profile?.name ?? 'Suki'

const ogArticle = post
  ? {
      publishedTime: new Date(post.frontmatter.publishedAt).toISOString(),
      tags: post.frontmatter.tags,
    }
  : undefined

const jsonLd = post
  ? JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'BlogPosting',
      headline: post.frontmatter.title,
      description: post.frontmatter.summary,
      datePublished: new Date(post.frontmatter.publishedAt).toISOString(),
      author: { '@type': 'Person', name: authorName },
      mainEntityOfPage: { '@type': 'WebPage', '@id': canonicalUrl },
      ...(post.frontmatter.cover ? { image: post.frontmatter.cover } : {}),
    })
  : undefined
---

<Default
  title={post ? post.frontmatter.title : `文章: ${slug}`}
  description={post ? post.frontmatter.summary : '文章详情'}
  ogType={post ? 'article' : 'website'}
  ogImage={post?.frontmatter.cover}
  ogArticle={ogArticle}
>
  {jsonLd && (
    <script is:inline type="application/ld+json" set:html={jsonLd} slot="head" />
  )}
  {post ? (
    <article class="tsuki-content-card" data-pagefind-body>
      <header class="post-header">
        <h1 class="post-detail-title">
          {post.frontmatter.title}
        </h1>
        <div class="post-meta">
          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:calendar-today-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <time datetime={post.frontmatter.publishedAt} class="tsuki-meta-text">{post.frontmatter.publishedAt}</time>
          </span>

          {post.frontmatter.category && (
            <span class="tsuki-meta-row">
              <span class="tsuki-meta-icon-badge">
                <Icon name="material-symbols:book-2-outline-rounded" class="tsuki-meta-icon" />
              </span>
              <a href={`/posts?category=${toSlug(post.frontmatter.category)}`} class="tsuki-meta-text detail-meta-link">{post.frontmatter.category}</a>
            </span>
          )}

          {post.frontmatter.series && (
            <span class="tsuki-meta-row">
              <span class="tsuki-meta-icon-badge">
                <Icon name="material-symbols:collections-bookmark-outline-rounded" class="tsuki-meta-icon" />
              </span>
              <a href={`/posts?series=${toSlug(post.frontmatter.series)}`} class="tsuki-meta-text detail-meta-link">{post.frontmatter.series}</a>
            </span>
          )}

          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:article-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <span class="tsuki-meta-text">{post.words} 字</span>
          </span>

          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:schedule-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <span class="tsuki-meta-text">{readingTime} 分钟</span>
          </span>

          {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
            <span class="tsuki-meta-row">
              <span class="tsuki-meta-icon-badge">
                <span class="tag-hash-badge">#</span>
              </span>
              <span class="tsuki-meta-text tag-inline-text">
                {post.frontmatter.tags.map((tag, i) => (
                  <>
                    <a href={`/posts?tag=${toSlug(tag)}`} class="tag-inline-label detail-meta-link">{tag}</a>{i < post.frontmatter.tags.length - 1 && <span class="tag-sep">/</span>}
                  </>
                ))}
              </span>
            </span>
          )}
        </div>
      </header>
      <div class="prose">
        <post.Content />
      </div>
      <CommentSection client:visible targetType="post" targetId={slug!} />
    </article>
  ) : (
    <div class="tsuki-content-card">
      <p class="not-found-text">
        未找到文章 {slug}
      </p>
    </div>
  )}
  <div slot="right">
    {post && <TableOfContents headings={post.headings} />}
  </div>
</Default>

<style>
  .post-header {
    margin-bottom: var(--tsuki-space-2xl);
    border-bottom: 1px solid var(--tsuki-surface-border);
    padding-bottom: var(--tsuki-space-lg);
  }

  .post-detail-title {
    margin-bottom: var(--tsuki-space-md);
    font-size: var(--tsuki-text-3xl);
    font-weight: 600;
    line-height: var(--tsuki-line-height-heading);
    color: var(--tsuki-fg);
  }
  @media (min-width: 768px) {
    .post-detail-title {
      position: relative;
    }
    .post-detail-title::before {
      content: '';
      position: absolute;
      top: var(--tsuki-space-md);
      left: calc(var(--tsuki-space-xl) * -1);
      height: var(--tsuki-space-xl);
      width: var(--tsuki-space-2xs);
      border-radius: var(--tsuki-radius-xs);
      background: var(--tsuki-theme-accent);
    }
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-sm) var(--tsuki-space-md);
    margin-bottom: var(--tsuki-space-sm);
  }

  .tag-hash-badge {
    font-size: var(--tsuki-meta-icon-size);
    font-weight: 700;
    color: var(--tsuki-theme-accent);
  }

  .tag-inline-text {
    display: inline-flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-2xs);
    white-space: normal;
  }

  .tag-inline-label {
    color: var(--tsuki-muted-fg);
    text-decoration: none;
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .tag-inline-label:hover {
    color: var(--tsuki-theme-accent);
  }

  .detail-meta-link {
    text-decoration: none;
    color: var(--tsuki-muted-fg);
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .detail-meta-link:hover {
    color: var(--tsuki-theme-accent);
  }

  .tag-sep {
    color: var(--tsuki-muted-fg);
    margin-inline: var(--tsuki-space-3xs);
  }

  .not-found-text {
    margin: 0;
    font-size: var(--tsuki-text-sm);
    color: var(--tsuki-fg);
  }
</style>
