---
import Default from '@/layouts/Default.astro'
import TableOfContents from '@/components/TableOfContents.astro'
import { Icon } from 'astro-icon/components'
import { createAppContext } from '@entry/index'
import { getPostCards, getPostDetail } from '@usecases/content'

export async function getStaticPaths() {
  const ctx = createAppContext()
  const posts = await getPostCards(ctx)
  return posts.map((post) => ({ params: { slug: post.slug } }))
}

const { slug } = Astro.params
const ctx = createAppContext()
const post = await getPostDetail(ctx, slug)
const readingTime = post ? Math.max(1, Math.ceil(post.frontmatter.words / 300)) : 0
---

<Default title={post ? post.frontmatter.title : `文章: ${slug}`} description="文章详情" hasRightSidebar={!!post}>
  {post ? (
    <article class="tsuki-content-card" transition:name="page-card">
      <header class="post-header">
        <h1 class="post-detail-title">
          {post.frontmatter.title}
        </h1>
        <div class="post-meta">
          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:calendar-today-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <time datetime={post.frontmatter.publishedAt} class="tsuki-meta-text">{post.frontmatter.publishedAt}</time>
          </span>

          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:book-2-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <span class="tsuki-meta-text">{post.frontmatter.category}</span>
          </span>

          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:article-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <span class="tsuki-meta-text">{post.frontmatter.words} 字</span>
          </span>

          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:schedule-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <span class="tsuki-meta-text">{readingTime} 分钟</span>
          </span>

          {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
            <span class="tsuki-meta-row">
              <span class="tsuki-meta-icon-badge tag-hash-badge">
                #
              </span>
              <span class="tsuki-meta-text">{post.frontmatter.tags.join(' / ')}</span>
            </span>
          )}
        </div>
      </header>
      <div class="prose">
        <post.Content />
      </div>
    </article>
  ) : (
    <div class="tsuki-content-card">
      <p class="not-found-text">
        未找到文章 {slug}
      </p>
    </div>
  )}
  <div slot="right">
    {post && <TableOfContents headings={post.headings} />}
  </div>
</Default>

<style>
  .post-header {
    margin-bottom: var(--tsuki-space-1-5);
    border-bottom: 1px solid var(--tsuki-surface-border);
    padding-bottom: var(--tsuki-space-1);
  }

  .post-detail-title {
    margin-bottom: var(--tsuki-space-0-75);
    font-size: var(--tsuki-text-3xl);
    font-weight: 600;
    line-height: var(--tsuki-line-height-heading);
    color: var(--tsuki-fg);
  }
  @media (min-width: 768px) {
    .post-detail-title {
      position: relative;
    }
    .post-detail-title::before {
      content: '';
      position: absolute;
      top: var(--tsuki-space-0-7);
      left: calc(var(--tsuki-space-1-25) * -1);
      height: var(--tsuki-space-1-25);
      width: var(--tsuki-space-0-25);
      border-radius: var(--tsuki-radius-xs);
      background: var(--tsuki-theme-accent);
    }
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-0-6) var(--tsuki-space-0-85);
    margin-bottom: var(--tsuki-space-0-5);
  }

  .tag-hash-badge {
    font-size: var(--tsuki-meta-icon-size);
    font-weight: 700;
    color: var(--tsuki-theme-accent);
  }

  .not-found-text {
    margin: 0;
    font-size: var(--tsuki-text-sm);
    color: var(--tsuki-fg);
  }
</style>
