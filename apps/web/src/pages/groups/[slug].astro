---
import Default from '@/layouts/Default.astro'
import PostCard from '@/components/PostCard.astro'
import { toPostCardItems, toSlug } from '@atoms/post-cards'
import { createAppContext } from '@entry/index'
import { getPostEntries } from '@usecases/content'

export const prerender = true

export async function getStaticPaths() {
  const ctx = createAppContext()
  const posts = await getPostEntries(ctx)
  const groups = new Set<string>()
  posts.forEach((post) => {
    if (post.frontmatter.category) {
      groups.add(toSlug(post.frontmatter.category))
    }
  })
  return Array.from(groups).map((group) => ({ params: { slug: group } }))
}

const { slug } = Astro.params
const ctx = createAppContext()
const posts = await getPostEntries(ctx)
const filtered = posts.filter((post) => post.frontmatter.category && toSlug(post.frontmatter.category) === slug)
const postCards = toPostCardItems(filtered)
---

<Default title={`分组: ${slug}`} description={`分组 ${slug} 下的文章`}>
  <section class="page-section">
    <h1 class="tsuki-page-title">{slug}</h1>
    {postCards.length > 0 ? (
      <div class="tsuki-card-list">
        {postCards.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
    ) : (
      <p class="tsuki-empty-state">该分组下暂无文章</p>
    )}
  </section>
</Default>

<style>
  .page-section {
    margin-bottom: var(--tsuki-space-2);
  }
</style>
