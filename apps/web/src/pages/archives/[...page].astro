---
import type { GetStaticPathsOptions } from 'astro'
import Default from '@/layouts/Default.astro'
import Pagination from '@/components/content/Pagination.astro'
import { toPostCardItems, toSlug } from '@/lib/utils/post-cards'
import { getPostEntries } from '@/lib/content'

export const prerender = true

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getPostEntries()
  const sorted = toPostCardItems(posts)
  return paginate(sorted, { pageSize: 30 })
}

const { page } = Astro.props

// 按年分组
interface YearGroup {
  year: number
  items: typeof page.data
}

const groups: YearGroup[] = []
let currentYear = -1

page.data.forEach((post) => {
  const date = new Date(post.publishedAt)
  const year = date.getFullYear()

  if (year !== currentYear) {
    currentYear = year
    groups.push({ year, items: [] })
  }
  groups[groups.length - 1]!.items.push(post)
})

function fmtDate(dateStr: string): string {
  const d = new Date(dateStr)
  return `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
}
---

<Default title={page.currentPage > 1 ? `归档 - 第 ${page.currentPage} 页` : '归档'} description="文章归档">
  <section class="archive-section">
    <div class="filter-bar" id="filter-bar">
      <span class="filter-label" id="filter-label"></span>
      <a href="/archives" class="filter-clear" id="filter-clear">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </a>
    </div>

    {groups.length > 0 ? (
      <div class="archive-card" id="post-list">
        <div class="timeline">
          {groups.map((group) => (
            <div class="timeline-group" data-group>
              <div class="timeline-year-header">
                <span class="timeline-year">{group.year}</span>
                <span class="timeline-year-marker"></span>
                <span class="timeline-year-count">{group.items.length} 篇文章</span>
              </div>
              <div class="timeline-items">
                {group.items.map((post) => (
                  <a
                    href={`/posts/${post.slug}`}
                    class="timeline-item"
                    data-tags={post.tags.map(t => toSlug(t)).join(',')}
                    data-category={post.category ? toSlug(post.category) : ''}
                    data-series={post.series ? toSlug(post.series) : ''}
                  >
                    <span class="timeline-item-date">{fmtDate(post.publishedAt)}</span>
                    <span class="timeline-item-marker"></span>
                    <span class="timeline-item-title">{post.title}</span>
                    {post.tags.length > 0 && (
                      <span class="timeline-item-tags">{post.tags.map(t => `#${t}`).join(' ')}</span>
                    )}
                  </a>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    ) : (
      <p class="tsuki-empty-state">暂无文章</p>
    )}

    <p class="tsuki-empty-state filter-empty" id="filter-empty">无匹配文章</p>

    <div id="pagination-wrap">
      {page.lastPage > 1 && (
        <Pagination
          currentPage={page.currentPage}
          totalPages={page.lastPage}
          baseUrl="/archives"
        />
      )}
    </div>
  </section>
</Default>

<script>
  function initPostFilter() {
    const params = new URLSearchParams(window.location.search)
    const tag = params.get('tag')
    const category = params.get('category')
    const series = params.get('series')

    const filterBar = document.getElementById('filter-bar')
    const filterLabel = document.getElementById('filter-label')
    const filterEmpty = document.getElementById('filter-empty')
    const paginationWrap = document.getElementById('pagination-wrap')
    const postList = document.getElementById('post-list')
    if (!filterBar || !filterLabel || !filterEmpty || !paginationWrap) return

    const filterKey = tag ? 'tag' : category ? 'category' : series ? 'series' : null
    const filterValue = tag || category || series
    if (!filterKey || !filterValue) return

    const labels: Record<string, string> = {
      tag: '标签',
      category: '分类',
      series: '系列',
    }

    filterLabel.textContent = `${labels[filterKey]}：${filterValue}`
    filterBar.classList.add('active')
    paginationWrap.style.display = 'none'

    if (!postList) return

    const items = postList.querySelectorAll<HTMLElement>('.timeline-item')
    let visibleCount = 0

    items.forEach((item) => {
      const attr = item.getAttribute(`data-${filterKey === 'tag' ? 'tags' : filterKey}`) || ''
      const values = attr.split(',').filter(Boolean)
      const match = values.some(v => v === filterValue)
      if (!match) {
        item.style.display = 'none'
      } else {
        visibleCount++
      }
    })

    // 隐藏空的年份组
    postList.querySelectorAll<HTMLElement>('[data-group]').forEach((group) => {
      const visibleItems = group.querySelectorAll<HTMLElement>('.timeline-item:not([style*="display: none"])')
      if (visibleItems.length === 0) {
        group.style.display = 'none'
      }
    })

    if (visibleCount === 0) {
      filterEmpty.classList.add('active')
    }
  }

  initPostFilter()
  document.addEventListener('astro:page-load', initPostFilter)
</script>

<style>
  .archive-section {
    margin-bottom: var(--tsuki-space-3xl);
  }

  /* ── Filter Bar ── */
  .filter-bar {
    display: none;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--tsuki-space-lg);
    padding: var(--tsuki-space-sm) var(--tsuki-space-lg);
    border-radius: var(--tsuki-radius-md);
    border: 1px solid var(--tsuki-theme-accent);
    background: color-mix(in srgb, var(--tsuki-theme-accent) 8%, transparent);
  }
  .filter-bar.active {
    display: flex;
  }

  .filter-label {
    font-size: var(--tsuki-text-sm);
    font-weight: 500;
    color: var(--tsuki-fg);
  }

  .filter-clear {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--tsuki-muted-fg);
    text-decoration: none;
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .filter-clear:hover {
    color: var(--tsuki-fg);
  }

  .filter-empty {
    display: none;
  }
  .filter-empty.active {
    display: block;
  }

  /* ── Archive Card Container ── */
  .archive-card {
    background: var(--tsuki-sidebar-card-bg);
    border: 1px solid var(--tsuki-sidebar-card-border);
    border-radius: var(--tsuki-sidebar-card-radius);
    box-shadow: var(--tsuki-sidebar-card-shadow);
    padding: var(--tsuki-space-2xl) var(--tsuki-space-2xl);
    overflow: hidden;
  }

  /* ── Timeline ── */
  .timeline {
    --tl-date-w: 5rem;
    --tl-marker-w: 1.5rem;
    --tl-gap: 0.75rem;
    --tl-line-x: calc(var(--tl-date-w) + var(--tl-gap) + var(--tl-marker-w) / 2);
    position: relative;
  }

  /* 灰色虚线 */
  .timeline::before {
    content: '';
    position: absolute;
    left: var(--tl-line-x);
    top: 0;
    bottom: 0;
    width: 0;
    border-left: 2px dashed var(--tsuki-surface-border);
  }

  /* ── Year Group ── */
  .timeline-group {
    position: relative;
    margin-bottom: var(--tsuki-space-2xl);
  }
  .timeline-group:last-child {
    margin-bottom: 0;
  }

  /* ── Year Header ── */
  .timeline-year-header {
    display: grid;
    grid-template-columns: var(--tl-date-w) var(--tl-marker-w) 1fr;
    column-gap: var(--tl-gap);
    align-items: center;
    margin-bottom: var(--tsuki-space-md);
    padding-block: var(--tsuki-space-xs);
  }

  .timeline-year {
    font-size: var(--tsuki-text-3xl);
    font-weight: 800;
    color: var(--tsuki-fg);
    text-align: right;
    line-height: 1;
    letter-spacing: -0.02em;
  }

  .timeline-year-marker {
    width: 0.875rem;
    height: 0.875rem;
    border-radius: 50%;
    border: 2px solid var(--tsuki-theme-accent);
    background: var(--tsuki-sidebar-card-bg);
    justify-self: center;
    position: relative;
    z-index: 1;
  }

  .timeline-year-count {
    font-size: var(--tsuki-text-sm);
    color: var(--tsuki-muted-fg);
    font-weight: 500;
  }

  /* ── Items Container ── */
  .timeline-items {
    display: flex;
    flex-direction: column;
  }

  /* ── Article Item ── */
  .timeline-item {
    display: grid;
    grid-template-columns: var(--tl-date-w) var(--tl-marker-w) 1fr auto;
    column-gap: var(--tl-gap);
    align-items: center;
    padding: var(--tsuki-space-sm) var(--tsuki-space-md);
    margin-inline: calc(-1 * var(--tsuki-space-md));
    border-radius: var(--tsuki-radius-md);
    text-decoration: none;
    color: var(--tsuki-fg);
    transition: background-color var(--tsuki-motion-fast) ease;
  }

  .timeline-item:hover {
    background: color-mix(in srgb, var(--tsuki-theme-accent) 8%, transparent);
  }

  /* 日期 */
  .timeline-item-date {
    font-size: var(--tsuki-text-sm);
    font-weight: 500;
    color: var(--tsuki-muted-fg);
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* 圆点标记（默认：次要色小圆点） */
  .timeline-item-marker {
    width: 0.375rem;
    height: 0.375rem;
    border-radius: 50%;
    background: var(--tsuki-muted-fg);
    justify-self: center;
    position: relative;
    z-index: 1;
    transition:
      width var(--tsuki-motion-fast) ease,
      height var(--tsuki-motion-fast) ease,
      border-radius var(--tsuki-motion-fast) ease,
      background-color var(--tsuki-motion-fast) ease;
  }

  /* 悬停：圆点 → 短竖条 */
  .timeline-item:hover .timeline-item-marker {
    width: 0.25rem;
    height: 1rem;
    border-radius: 0.125rem;
    background: var(--tsuki-theme-accent);
  }

  /* 文章标题 */
  .timeline-item-title {
    font-size: var(--tsuki-text-sm);
    font-weight: 600;
    color: var(--tsuki-fg);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color var(--tsuki-motion-fast) ease;
  }
  .timeline-item:hover .timeline-item-title {
    color: var(--tsuki-theme-accent);
  }

  /* 标签 */
  .timeline-item-tags {
    font-size: var(--tsuki-text-xs);
    color: var(--tsuki-muted-fg);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 10rem;
    text-align: right;
    flex-shrink: 0;
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .timeline {
      --tl-date-w: 3.5rem;
      --tl-marker-w: 1.25rem;
      --tl-gap: 0.5rem;
    }

    .archive-card {
      padding: var(--tsuki-space-xl) var(--tsuki-space-lg);
    }

    .timeline-year {
      font-size: var(--tsuki-text-2xl);
    }

    .timeline-item-tags {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .timeline {
      --tl-date-w: 2.75rem;
    }

    .timeline-item-date {
      font-size: var(--tsuki-text-xs);
    }
  }
</style>
