---
import Default from '@/layouts/Default.astro'
import PostCard from '@/components/PostCard.astro'
import { toPostCardItems } from '@atoms/post-cards'
import { createAppContext } from '@entry/index'
import { getPostCards } from '@usecases/content'

function toSlug(value: string): string {
  return value.trim().toLowerCase().replace(/\\s+/g, '-')
}

export async function getStaticPaths() {
  const ctx = createAppContext()
  const posts = await getPostCards(ctx)
  const tags = new Set<string>()
  posts.forEach((post) => {
    post.frontmatter.tags.forEach((tag) => tags.add(toSlug(tag)))
  })
  return Array.from(tags).map((tag) => ({ params: { slug: tag } }))
}

const { slug } = Astro.params
const ctx = createAppContext()
const posts = await getPostCards(ctx)
const filtered = posts.filter((post) =>
  post.frontmatter.tags.some((tag) => toSlug(tag) === slug)
)
const postCards = toPostCardItems(filtered)
---

<Default title={`标签: ${slug}`} description={`标签 ${slug} 下的内容`}>
  <section class="mb-[var(--tsuki-space-2)]" transition:name="page-card">
    <h1 class="mb-[var(--tsuki-space-1-5)] text-[length:var(--tsuki-text-page-title)]">#{slug}</h1>
    {postCards.length > 0 ? (
      <div class="flex flex-col gap-[var(--tsuki-space-1)]">
        {postCards.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
    ) : (
      <p class="italic text-[color:var(--tsuki-fg)]">该标签下暂无内容</p>
    )}
  </section>
</Default>
