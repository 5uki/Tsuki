---
import Default from '@/layouts/Default.astro'
import ImageGrid from '@/components/ImageGrid.astro'
import Lightbox from '@/components/Lightbox.astro'
import { Icon } from 'astro-icon/components'
import { createAppContext } from '@entry/index'
import { getMomentDetail, getMomentEntries } from '@usecases/content'
import { filterSafeMedia } from '@atoms/moment-cards'
import { toSlug } from '@atoms/post-cards'

export const prerender = true

export async function getStaticPaths() {
  const ctx = createAppContext()
  const moments = await getMomentEntries(ctx)
  return moments.map((moment) => ({ params: { id: moment.id } }))
}

const { id } = Astro.params
const ctx = createAppContext()
const moment = await getMomentDetail(ctx, id)
const media = moment ? filterSafeMedia(moment.frontmatter.media) : []
---

<Default title={moment ? moment.frontmatter.title : '动态'} description="动态详情">
  {moment ? (
    <article class="tsuki-content-card">
      <header class="moment-header">
        <h1 class="moment-detail-title">
          {moment.frontmatter.title}
        </h1>
        <div class="moment-meta">
          <span class="tsuki-meta-row">
            <span class="tsuki-meta-icon-badge">
              <Icon name="material-symbols:calendar-today-outline-rounded" class="tsuki-meta-icon" />
            </span>
            <time datetime={moment.frontmatter.publishedAt} class="tsuki-meta-text">{moment.frontmatter.publishedAt}</time>
          </span>

          {moment.frontmatter.category && (
            <a href={`/groups/${toSlug(moment.frontmatter.category)}`} class="tsuki-meta-row tsuki-meta-link">
              <span class="tsuki-meta-icon-badge">
                <Icon name="material-symbols:book-2-outline-rounded" class="tsuki-meta-icon" />
              </span>
              <span class="tsuki-meta-text">{moment.frontmatter.category}</span>
            </a>
          )}

          {moment.frontmatter.series && (
            <span class="tsuki-meta-row">
              <span class="tsuki-meta-icon-badge">
                <Icon name="material-symbols:collections-bookmark-outline-rounded" class="tsuki-meta-icon" />
              </span>
              <span class="tsuki-meta-text">{moment.frontmatter.series}</span>
            </span>
          )}
        </div>

        {moment.frontmatter.tags && moment.frontmatter.tags.length > 0 && (
          <div class="moment-meta" style="margin-top: var(--tsuki-space-0-5);">
            <span class="tsuki-meta-row">
              <span class="tsuki-meta-icon-badge">
                <span class="tag-hash-badge">#</span>
              </span>
              <span class="tsuki-meta-text tag-inline-text">
                {moment.frontmatter.tags.map((tag, i) => (
                  <>
                    <a href={`/tags/${tag.toLowerCase()}`} class="tag-inline-link">{tag}</a>{i < (moment.frontmatter.tags?.length ?? 0) - 1 && <span class="tag-sep">/</span>}
                  </>
                ))}
              </span>
            </span>
          </div>
        )}
      </header>
      <div class="prose">
        <moment.Content />
      </div>
      {media.length > 0 && (
        <div class="moment-images">
          <ImageGrid images={media} maxDisplay={99} />
        </div>
      )}
      <div class="comment-placeholder"><!-- 评论区将在 M4 接入 --></div>
    </article>
  ) : (
    <div class="tsuki-content-card">
      <p class="not-found-text">
        未找到动态 {id}
      </p>
    </div>
  )}
  <Lightbox />
</Default>

<style>
  .moment-header {
    margin-bottom: var(--tsuki-space-1-5);
    border-bottom: 1px solid var(--tsuki-surface-border);
    padding-bottom: var(--tsuki-space-1);
  }

  .moment-detail-title {
    margin-bottom: var(--tsuki-space-0-75);
    font-size: var(--tsuki-text-3xl);
    font-weight: 600;
    line-height: var(--tsuki-line-height-heading);
    color: var(--tsuki-fg);
  }
  @media (min-width: 768px) {
    .moment-detail-title {
      position: relative;
    }
    .moment-detail-title::before {
      content: '';
      position: absolute;
      top: var(--tsuki-space-0-7);
      left: calc(var(--tsuki-space-1-25) * -1);
      height: var(--tsuki-space-1-25);
      width: var(--tsuki-space-0-25);
      border-radius: var(--tsuki-radius-xs);
      background: var(--tsuki-theme-accent);
    }
  }

  .moment-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-0-6) var(--tsuki-space-0-85);
    margin-bottom: var(--tsuki-space-0-5);
  }

  .tag-hash-badge {
    font-size: var(--tsuki-meta-icon-size);
    font-weight: 700;
    color: var(--tsuki-theme-accent);
  }

  .tag-inline-text {
    display: inline-flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-0-2);
    white-space: normal;
  }

  .tag-inline-link {
    color: var(--tsuki-fg);
    text-decoration: none;
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .tag-inline-link:hover {
    color: var(--tsuki-theme-accent);
  }

  .tag-sep {
    color: var(--tsuki-post-muted-fg);
    margin-inline: var(--tsuki-space-0-15);
  }

  .moment-images {
    margin-top: var(--tsuki-space-1-5);
    padding-top: var(--tsuki-space-1);
    border-top: 1px solid var(--tsuki-surface-border);
  }

  .comment-placeholder {
    margin-top: var(--tsuki-space-2);
    padding-top: var(--tsuki-space-1);
    border-top: 1px solid var(--tsuki-surface-border);
  }

  .not-found-text {
    margin: 0;
    font-size: var(--tsuki-text-sm);
    color: var(--tsuki-fg);
  }
</style>
