---
import Default from '@/layouts/Default.astro'
import ImageGrid from '@/components/content/ImageGrid.astro'
import Lightbox from '@/components/content/Lightbox.astro'
import CommentSection from '@/components/comments/CommentSection'
import { Icon } from 'astro-icon/components'
import { getMomentById, getMomentEntries } from '@/lib/content'
import { filterSafeMedia } from '@/lib/utils/moment-cards'
import { toOptimizedImageUrl } from '@/lib/utils/image-url'

export const prerender = true

export async function getStaticPaths() {
  const moments = await getMomentEntries()
  return moments.map((moment) => ({ params: { id: moment.id } }))
}

const { id } = Astro.params
const moment = await getMomentById(id)
const media = moment
  ? filterSafeMedia(moment.frontmatter.media).map((src) => toOptimizedImageUrl(src) ?? src)
  : []

const momentDescription = moment?.body
  ? moment.body
      .replace(/[#*_`>[\]()!~]/g, '')
      .trim()
      .slice(0, 100)
  : '动态详情'
const momentOgImage = media.length > 0 ? media[0] : undefined
---

<Default
  title={moment ? moment.frontmatter.title : '动态'}
  description={momentDescription}
  ogImage={momentOgImage}
>
  {
    moment ? (
      <article class="tsuki-content-card">
        <header class="moment-header">
          <h1 class="moment-detail-title">{moment.frontmatter.title}</h1>
          <div class="moment-meta">
            <span class="tsuki-meta-row">
              <span class="tsuki-meta-icon-badge">
                <Icon
                  name="material-symbols:calendar-today-outline-rounded"
                  class="tsuki-meta-icon"
                />
              </span>
              <time datetime={moment.frontmatter.publishedAt} class="tsuki-meta-text">
                {moment.frontmatter.publishedAt}
              </time>
            </span>

            {moment.frontmatter.category && (
              <span class="tsuki-meta-row">
                <span class="tsuki-meta-icon-badge">
                  <Icon name="material-symbols:book-2-outline-rounded" class="tsuki-meta-icon" />
                </span>
                <span class="tsuki-meta-text">{moment.frontmatter.category}</span>
              </span>
            )}

            {moment.frontmatter.series && (
              <span class="tsuki-meta-row">
                <span class="tsuki-meta-icon-badge">
                  <Icon
                    name="material-symbols:collections-bookmark-outline-rounded"
                    class="tsuki-meta-icon"
                  />
                </span>
                <span class="tsuki-meta-text">{moment.frontmatter.series}</span>
              </span>
            )}
          </div>

          {moment.frontmatter.tags && moment.frontmatter.tags.length > 0 && (
            <div class="moment-meta" style="margin-top: var(--tsuki-space-sm);">
              <span class="tsuki-meta-row">
                <span class="tsuki-meta-icon-badge">
                  <span class="tag-hash-badge">#</span>
                </span>
                <span class="tsuki-meta-text tag-inline-text">
                  {moment.frontmatter.tags.map((tag, i) => (
                    <>
                      <span class="tag-inline-label">{tag}</span>
                      {i < (moment.frontmatter.tags?.length ?? 0) - 1 && (
                        <span class="tag-sep">/</span>
                      )}
                    </>
                  ))}
                </span>
              </span>
            </div>
          )}
        </header>
        <div class="prose">
          <moment.Content />
        </div>
        {media.length > 0 && (
          <div class="moment-images">
            <ImageGrid images={media} maxDisplay={99} />
          </div>
        )}
        <CommentSection client:visible targetType="moment" targetId={id!} />
      </article>
    ) : (
      <div class="tsuki-content-card">
        <p class="not-found-text">未找到动态 {id}</p>
      </div>
    )
  }
  <Lightbox />
</Default>

<style>
  .moment-header {
    margin-bottom: var(--tsuki-space-2xl);
    border-bottom: 1px solid var(--tsuki-surface-border);
    padding-bottom: var(--tsuki-space-lg);
  }

  .moment-detail-title {
    margin-bottom: var(--tsuki-space-md);
    font-size: var(--tsuki-text-3xl);
    font-weight: 600;
    line-height: var(--tsuki-line-height-heading);
    color: var(--tsuki-fg);
  }
  @media (min-width: 768px) {
    .moment-detail-title {
      position: relative;
    }
    .moment-detail-title::before {
      content: '';
      position: absolute;
      top: var(--tsuki-space-md);
      left: calc(var(--tsuki-space-xl) * -1);
      height: var(--tsuki-space-xl);
      width: var(--tsuki-space-2xs);
      border-radius: var(--tsuki-radius-xs);
      background: var(--tsuki-theme-accent);
    }
  }

  .moment-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-sm) var(--tsuki-space-md);
    margin-bottom: var(--tsuki-space-sm);
  }

  .tag-hash-badge {
    font-size: var(--tsuki-meta-icon-size);
    font-weight: 700;
    color: var(--tsuki-theme-accent);
  }

  .tag-inline-text {
    display: inline-flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--tsuki-space-2xs);
    white-space: normal;
  }

  .tag-inline-link {
    color: var(--tsuki-fg);
    text-decoration: none;
    transition: color var(--tsuki-motion-fast) var(--tsuki-motion-ease-out);
  }
  .tag-inline-link:hover {
    color: var(--tsuki-theme-accent);
  }

  .tag-sep {
    color: var(--tsuki-muted-fg);
    margin-inline: var(--tsuki-space-3xs);
  }

  .moment-images {
    margin-top: var(--tsuki-space-2xl);
    padding-top: var(--tsuki-space-lg);
    border-top: 1px solid var(--tsuki-surface-border);
  }

  .not-found-text {
    margin: 0;
    font-size: var(--tsuki-text-sm);
    color: var(--tsuki-fg);
  }
</style>
