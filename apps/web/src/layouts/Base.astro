---
import '@/styles/global.css'
import '@/styles/themes.css'
import tsukiConfig from '@/config/tsuki-config'
import { DEFAULT_THEME, getSafeTheme } from '@tsuki/shared/theme'
import { ViewTransitions } from 'astro:transitions'

interface Props {
  title: string
  description?: string
  noindex?: boolean
}

const defaultTheme = getSafeTheme(tsukiConfig.site.defaultTheme ?? DEFAULT_THEME)
const { title, description = tsukiConfig.site.description ?? 'Tsuki 博客', noindex = false } = Astro.props
const canonicalUrl = Astro.site ? new URL(Astro.url.pathname, Astro.site) : Astro.url
const rawFaviconHref = tsukiConfig.site.faviconHref ?? '/favicon.svg'
const faviconHref =
  rawFaviconHref.startsWith('http://') ||
  rawFaviconHref.startsWith('https://') ||
  rawFaviconHref.startsWith('/')
    ? rawFaviconHref
    : `/${rawFaviconHref}`
const faviconType = faviconHref.endsWith('.svg') ? 'image/svg+xml' : undefined

const rawTopBgImageHref = tsukiConfig.hero?.backgroundImageHref?.trim()
const topBgImageHref =
  rawTopBgImageHref &&
  (rawTopBgImageHref.startsWith('http://') ||
  rawTopBgImageHref.startsWith('https://') ||
  rawTopBgImageHref.startsWith('/')
    ? rawTopBgImageHref
    : `/${rawTopBgImageHref}`)

const isHome = Astro.url.pathname === '/'
const bodyVars: string[] = []
if (topBgImageHref) {
  bodyVars.push(`--tsuki-banner-image: url('${topBgImageHref}');`)
}
if (!isHome) {
  bodyVars.push('--tsuki-banner-height: var(--tsuki-banner-height-compact);')
  bodyVars.push('--tsuki-banner-wave-height: var(--tsuki-banner-wave-height-compact);')
  bodyVars.push('--tsuki-banner-wave-max-height: var(--tsuki-banner-wave-max-height-compact);')
  bodyVars.push('--tsuki-banner-wave-min-height: var(--tsuki-banner-wave-min-height-compact);')
}
const bodyStyle = bodyVars.length > 0 ? bodyVars.join(' ') : undefined

// 主题列表用于验证
const VALID_THEMES = ['mauve']
---

<!doctype html>
<html lang="zh-CN" data-default-theme={defaultTheme}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
    <link rel="icon" href={faviconHref} type={faviconType} />
    <link rel="apple-touch-icon" href={faviconHref} />
    <title>{title}</title>
    <ViewTransitions />
    <script is:inline define:vars={{ defaultTheme: defaultTheme, validThemes: VALID_THEMES }}>
      // 主题初始化：内联脚本确保在渲染前执行
      (function() {
        const storageKey = 'tsuki.theme'
        let persisted = null
        try {
          persisted = localStorage.getItem(storageKey)
        } catch (error) {
          void error
        }
        let theme = persisted || defaultTheme
        if (theme === 'violet') {
          theme = 'mauve'
        }
        if (validThemes.indexOf(theme) === -1) {
          theme = defaultTheme
        }
        document.documentElement.setAttribute('data-theme', theme)
      })()
    </script>
    <script type="module" is:inline>
      import { navigate } from 'astro:transitions/client'

      const tsukiWindow = window

      if (!tsukiWindow.__tsukiTopFirstNavBound) {
        document.addEventListener('click', async (event) => {
          if (event.defaultPrevented) return
          if (event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return

          const target = event.target
          const link = target instanceof Element ? target.closest('a[href]') : null
          if (!link) return
          if (link.target === '_blank' || link.hasAttribute('download') || link.hasAttribute('data-astro-reload')) return

          const url = new URL(link.href, window.location.href)
          if (url.origin !== window.location.origin) return
          if (url.pathname === window.location.pathname && url.search === window.location.search && url.hash) return
          if (tsukiWindow.__tsukiTopFirstNavigating) return

          event.preventDefault()
          tsukiWindow.__tsukiTopFirstNavigating = true

          const startTop = window.scrollY
          const durationMs = Math.min(520, Math.max(140, Math.round(startTop * 0.45)))
          const startedAt = performance.now()

          if (startTop > 2) {
            window.scrollTo({ top: 0, behavior: 'smooth' })
            await new Promise((resolve) => {
              let done = false
              const finish = () => {
                if (done) return
                done = true
                window.removeEventListener('scroll', onScroll)
                resolve()
              }
              const onScroll = () => {
                if (window.scrollY <= 1) {
                  finish()
                }
              }
              window.addEventListener('scroll', onScroll, { passive: true })
              const tick = () => {
                if (done) return
                const elapsed = performance.now() - startedAt
                if (elapsed >= durationMs) {
                  window.scrollTo({ top: 0, behavior: 'auto' })
                  finish()
                } else {
                  requestAnimationFrame(tick)
                }
              }
              requestAnimationFrame(tick)
            })
          }

          await navigate(`${url.pathname}${url.search}${url.hash}`)
          tsukiWindow.__tsukiTopFirstNavigating = false
        }, { capture: true })

        tsukiWindow.__tsukiTopFirstNavBound = true
      }
    </script>
    <script
      is:inline
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
      async
    ></script>
  </head>
  <body style={bodyStyle}>
    <div
      class="absolute inset-x-0 top-0 z-0 h-[var(--tsuki-banner-height)] pointer-events-none bg-[var(--tsuki-top-backdrop-bg,var(--tsuki-theme-gradient))] bg-no-repeat bg-[length:100%_100%] bg-[position:0_0] [contain:paint]"
      aria-hidden="true"
    ></div>
    <div class="relative z-[1]">
      <slot />
    </div>
  </body>
</html>
