---
import '@/styles/global.css'
import tsukiConfig from '@/config/tsuki-config'
import { DEFAULT_THEME, getSafeTheme } from '@tsuki/shared/theme'

interface Props {
  title: string
  description?: string
  noindex?: boolean
  ogType?: string
  ogImage?: string
  ogArticle?: {
    publishedTime?: string
    modifiedTime?: string
    author?: string
    tags?: string[]
  }
}

const defaultTheme = getSafeTheme(tsukiConfig.site.defaultTheme ?? DEFAULT_THEME)
const {
  title,
  description = tsukiConfig.site.description ?? 'Tsuki 博客',
  noindex = false,
  ogType = 'website',
  ogImage,
  ogArticle,
} = Astro.props
const canonicalUrl = Astro.site ? new URL(Astro.url.pathname, Astro.site) : Astro.url
const siteUrl = Astro.site?.origin ?? ''
const ogImageUrl = ogImage
  ? ogImage.startsWith('http://') || ogImage.startsWith('https://')
    ? ogImage
    : `${siteUrl}${ogImage.startsWith('/') ? '' : '/'}${ogImage}`
  : undefined
const faviconHref = tsukiConfig.site.faviconHref ?? '/favicon.svg'
const faviconType = faviconHref.endsWith('.svg') ? 'image/svg+xml' : undefined

// defineConfig 已归一化路径，此处直接使用
const bgImages = (tsukiConfig.hero?.backgroundImages ?? [])
  .map((img) => ({
    href: img.href,
    positionX: Math.max(0, Math.min(100, img.positionX ?? 50)),
    positionY: Math.max(0, Math.min(100, img.positionY ?? 50)),
  }))
  .filter((img) => img.href)

// 单图兼容：没有 backgroundImages 时用 backgroundImage
if (bgImages.length === 0) {
  const singleHref = tsukiConfig.hero?.backgroundImage?.href
  if (singleHref) {
    bgImages.push({
      href: singleHref,
      positionX: Math.max(0, Math.min(100, tsukiConfig.hero?.backgroundImage?.positionX ?? 50)),
      positionY: Math.max(0, Math.min(100, tsukiConfig.hero?.backgroundImage?.positionY ?? 50)),
    })
  }
}

const isHome = Astro.url.pathname === '/'
const isSingleBg = bgImages.length === 1
const bodyVars: string[] = []

// 单图：SSR 直接写入 CSS 变量（零 JS，可 preload）
if (isSingleBg && bgImages[0]) {
  bodyVars.push(`--tsuki-banner-image: url('${bgImages[0].href}');`)
  bodyVars.push(`--tsuki-banner-image-position-x: ${bgImages[0].positionX}%;`)
  bodyVars.push(`--tsuki-banner-image-position-y: ${bgImages[0].positionY}%;`)
}
if (!isHome) {
  bodyVars.push('--tsuki-banner-height: var(--tsuki-banner-height-compact);')
}
const bodyStyle = bodyVars.length > 0 ? bodyVars.join(' ') : undefined

// 主题列表用于验证
const VALID_THEMES = ['mauve']
---

<!doctype html>
<html lang="zh-CN" data-default-theme={defaultTheme}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
    <link rel="icon" href={faviconHref} type={faviconType} />
    <link rel="apple-touch-icon" href={faviconHref} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl.toString()} />
    <meta property="og:type" content={ogType} />
    <meta property="og:site_name" content={tsukiConfig.site.title} />
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}

    <!-- Twitter Card -->
    <meta name="twitter:card" content={ogImageUrl ? 'summary_large_image' : 'summary'} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}

    <!-- Article meta -->
    {
      ogArticle?.publishedTime && (
        <meta property="article:published_time" content={ogArticle.publishedTime} />
      )
    }
    {
      ogArticle?.modifiedTime && (
        <meta property="article:modified_time" content={ogArticle.modifiedTime} />
      )
    }
    {ogArticle?.author && <meta property="article:author" content={ogArticle.author} />}
    {ogArticle?.tags?.map((tag) => <meta property="article:tag" content={tag} />)}

    <slot name="head" />
    {
      isSingleBg && bgImages[0] && (
        <link rel="preload" href={bgImages[0].href} as="image" fetchpriority="high" />
      )
    }
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
      /></noscript
    >
    <title>{title}</title>
    <script
      is:inline
      define:vars={{
        defaultTheme: defaultTheme,
        validThemes: VALID_THEMES,
        bannerImages: bgImages,
      }}
    >
      // 主题初始化：内联脚本确保在渲染前执行
      ;(function () {
        var storageKey = 'tsuki.theme'
        var persisted = null
        try {
          persisted = localStorage.getItem(storageKey)
        } catch (error) {
          void error
        }
        var theme = persisted || defaultTheme
        if (theme === 'violet') {
          theme = 'mauve'
        }
        if (validThemes.indexOf(theme) === -1) {
          theme = defaultTheme
        }
        document.documentElement.setAttribute('data-theme', theme)

        // 多背景图随机选择（window 内存缓存：刷新重选，SPA 导航保留）
        if (bannerImages.length > 1) {
          var img = window.__tsukiBannerBg
          if (!img || !img.href) {
            var idx = Math.floor(Math.random() * bannerImages.length)
            img = bannerImages[idx]
            window.__tsukiBannerBg = img
          }
          document.documentElement.style.setProperty(
            '--tsuki-banner-image',
            "url('" + img.href + "')"
          )
          document.documentElement.style.setProperty(
            '--tsuki-banner-image-position-x',
            img.positionX + '%'
          )
          document.documentElement.style.setProperty(
            '--tsuki-banner-image-position-y',
            img.positionY + '%'
          )
        }
      })()
    </script>
    <script>
      // Swup 页面切换后更新 banner 高度和内容可见性
      function updateBannerHeight() {
        const isHome = window.location.pathname === '/'
        if (isHome) {
          document.body.style.removeProperty('--tsuki-banner-height')
        } else {
          document.body.style.setProperty(
            '--tsuki-banner-height',
            'var(--tsuki-banner-height-compact)'
          )
        }

        // Banner 不在 swup 容器内，需要 JS 同步内容状态
        const bannerContent = document.querySelector('.tsuki-banner-content')
        if (bannerContent) {
          if (isHome) {
            bannerContent.setAttribute('data-home', '')
          } else {
            bannerContent.removeAttribute('data-home')
          }
        }
      }

      // 首次加载和每次 swup 导航后触发
      document.addEventListener('astro:page-load', updateBannerHeight)
    </script>
  </head>
  <body style={bodyStyle} data-is-home={isHome ? '' : undefined}>
    <slot />
  </body>
</html>
