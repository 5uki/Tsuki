---
import '@/styles/global.css'
import '@/styles/themes.css'
import tsukiConfig from '@/config/tsuki-config'
import { DEFAULT_THEME, getSafeTheme } from '@tsuki/shared/theme'
import { ViewTransitions } from 'astro:transitions'

interface Props {
  title: string
  description?: string
  noindex?: boolean
}

const defaultTheme = getSafeTheme(tsukiConfig.site.defaultTheme ?? DEFAULT_THEME)
const { title, description = tsukiConfig.site.description ?? 'Tsuki 博客', noindex = false } = Astro.props
const canonicalUrl = Astro.site ? new URL(Astro.url.pathname, Astro.site) : Astro.url
const rawFaviconHref = tsukiConfig.site.faviconHref ?? '/favicon.svg'
const faviconHref =
  rawFaviconHref.startsWith('http://') ||
  rawFaviconHref.startsWith('https://') ||
  rawFaviconHref.startsWith('/')
    ? rawFaviconHref
    : `/${rawFaviconHref}`
const faviconType = faviconHref.endsWith('.svg') ? 'image/svg+xml' : undefined

const rawTopBgImageHref = tsukiConfig.hero?.backgroundImage?.href?.trim()
const topBgImageHref =
  rawTopBgImageHref &&
  (rawTopBgImageHref.startsWith('http://') ||
  rawTopBgImageHref.startsWith('https://') ||
  rawTopBgImageHref.startsWith('/')
    ? rawTopBgImageHref
    : `/${rawTopBgImageHref}`)

const isHome = Astro.url.pathname === '/'
const bgPositionY = tsukiConfig.hero?.backgroundImage?.positionY ?? 50
const bodyVars: string[] = []
if (topBgImageHref) {
  bodyVars.push(`--tsuki-banner-image: url('${topBgImageHref}');`)
  bodyVars.push(`--tsuki-banner-image-position-y: ${Math.max(0, Math.min(100, bgPositionY))}%;`)
}
if (!isHome) {
  bodyVars.push('--tsuki-banner-height: var(--tsuki-banner-height-compact);')
}
const bodyStyle = bodyVars.length > 0 ? bodyVars.join(' ') : undefined
const bannerImageVar = topBgImageHref ? `url('${topBgImageHref}')` : 'none'

// 主题列表用于验证
const VALID_THEMES = ['mauve']
---

<!doctype html>
<html lang="zh-CN" data-default-theme={defaultTheme}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
    <link rel="icon" href={faviconHref} type={faviconType} />
    <link rel="apple-touch-icon" href={faviconHref} />
    <title>{title}</title>
    <ViewTransitions />
    <script is:inline define:vars={{ defaultTheme: defaultTheme, validThemes: VALID_THEMES, bannerImageVar: bannerImageVar }}>
      // 主题初始化：内联脚本确保在渲染前执行
      (function() {
        const storageKey = 'tsuki.theme'
        let persisted = null
        try {
          persisted = localStorage.getItem(storageKey)
        } catch (error) {
          void error
        }
        let theme = persisted || defaultTheme
        if (theme === 'violet') {
          theme = 'mauve'
        }
        if (validThemes.indexOf(theme) === -1) {
          theme = defaultTheme
        }
        document.documentElement.setAttribute('data-theme', theme)

        // 保存 banner 图片配置供 SPA 切换使用
        window.__tsukiBannerImage = bannerImageVar
      })()
    </script>
    <script type="module" is:inline>
      // SPA 切换前：将新页面的 body style 提前应用，确保 View Transition 能正确计算起止状态
      if (!window.__tsukiSwapBound) {
        // 跟踪 popstate（浏览器回退/前进）
        var __tsukiIsPopstate = false
        window.addEventListener('popstate', function() { __tsukiIsPopstate = true })

        document.addEventListener('astro:before-swap', (event) => {
          // 将当前页面的主题传递到新页面
          const currentTheme = document.documentElement.getAttribute('data-theme')
          if (currentTheme) {
            event.newDocument.documentElement.setAttribute('data-theme', currentTheme)
          }

          var oldHasCompact = !!document.body.style.getPropertyValue('--tsuki-banner-height')
          var newBody = event.newDocument.body
          var newHasCompact = !!newBody.style.getPropertyValue('--tsuki-banner-height')
          var sameHeight = oldHasCompact === newHasCompact

          if (__tsukiIsPopstate || sameHeight) {
            // 回退/前进 或 高度不变：不做动画，直接设置目标高度
            newBody.dataset.tsukiBannerSkipAnim = '1'
          } else {
            // 正向导航且高度变化：先用旧高度启动，再过渡
            newBody.dataset.tsukiBannerTarget = newHasCompact ? '1' : '0'
            if (oldHasCompact) {
              newBody.style.setProperty('--tsuki-banner-height', 'var(--tsuki-banner-height-compact)')
            } else {
              newBody.style.removeProperty('--tsuki-banner-height')
            }
          }
        })

        document.addEventListener('astro:after-swap', function() {
          var skipAnim = document.body.dataset.tsukiBannerSkipAnim
          var target = document.body.dataset.tsukiBannerTarget

          delete document.body.dataset.tsukiBannerSkipAnim
          delete document.body.dataset.tsukiBannerTarget

          if (skipAnim) {
            // 跳过动画：banner 立即到位
            var banner = document.querySelector('.tsuki-banner')
            if (banner) {
              banner.style.transition = 'none'
              requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                  banner.style.transition = ''
                })
              })
            }
            // 恢复回退前保存的滚动位置
            var savedY = history.state && history.state.__tsukiScrollY
            if (savedY !== undefined && savedY > 0) {
              requestAnimationFrame(function() {
                window.scrollTo(0, savedY)
              })
            }
          } else if (target !== undefined) {
            // 正向导航：触发 CSS transition
            requestAnimationFrame(function() {
              if (target === '1') {
                document.body.style.setProperty('--tsuki-banner-height', 'var(--tsuki-banner-height-compact)')
              } else {
                document.body.style.removeProperty('--tsuki-banner-height')
              }
            })
          }

          __tsukiIsPopstate = false
        })

        window.__tsukiSwapBound = true
      }
    </script>
    <script type="module" is:inline>
      import { navigate } from 'astro:transitions/client'

      const tsukiWindow = window

      if (!tsukiWindow.__tsukiTopFirstNavBound) {
        document.addEventListener('click', async (event) => {
          if (event.defaultPrevented) return
          if (event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return

          const target = event.target
          const link = target instanceof Element ? target.closest('a[href]') : null
          if (!link) return
          if (link.target === '_blank' || link.hasAttribute('download') || link.hasAttribute('data-astro-reload')) return

          const url = new URL(link.href, window.location.href)
          if (url.origin !== window.location.origin) return
          if (url.pathname === window.location.pathname && url.search === window.location.search && url.hash) return
          if (tsukiWindow.__tsukiTopFirstNavigating) return

          event.preventDefault()
          tsukiWindow.__tsukiTopFirstNavigating = true

          const startTop = window.scrollY

          // 保存原始滚动位置到当前 history entry，回退时可恢复
          try {
            const s = history.state || {}
            history.replaceState(Object.assign({}, s, { __tsukiScrollY: startTop }), '')
          } catch (e) { void e }

          const durationMs = Math.min(520, Math.max(140, Math.round(startTop * 0.45)))
          const startedAt = performance.now()

          if (startTop > 2) {
            window.scrollTo({ top: 0, behavior: 'smooth' })
            await new Promise((resolve) => {
              let done = false
              const finish = () => {
                if (done) return
                done = true
                window.removeEventListener('scroll', onScroll)
                resolve()
              }
              const onScroll = () => {
                if (window.scrollY <= 1) {
                  finish()
                }
              }
              window.addEventListener('scroll', onScroll, { passive: true })
              const tick = () => {
                if (done) return
                const elapsed = performance.now() - startedAt
                if (elapsed >= durationMs) {
                  window.scrollTo({ top: 0, behavior: 'auto' })
                  finish()
                } else {
                  requestAnimationFrame(tick)
                }
              }
              requestAnimationFrame(tick)
            })
          }

          await navigate(`${url.pathname}${url.search}${url.hash}`)
          tsukiWindow.__tsukiTopFirstNavigating = false
        }, { capture: true })

        tsukiWindow.__tsukiTopFirstNavBound = true
      }
    </script>
    <script is:inline>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
        },
      };
    </script>
    <script
      is:inline
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
      async
    ></script>
    <script>
      document.addEventListener('astro:page-load', () => {
        const MJ = (window as any).MathJax;
        if (MJ?.typesetPromise) {
          MJ.typesetPromise().catch(() => {});
        }
      });
    </script>
  </head>
  <body style={bodyStyle} data-is-home={isHome ? '' : undefined}>
    <slot />
  </body>
</html>
